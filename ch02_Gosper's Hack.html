
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gosper's Hack åŠ¨ç”»æ¼”ç¤º</title>
<script src="alpine.min.js" defer></script>
<script src="echarts.min.js"></script>
<link rel="stylesheet" href="tailwind.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
:root {
  --bg-dark: #0f172a;
  --bg-card: #1e293b;
  --bg-card2: #334155;
  --accent-cyan: #22d3ee;
  --accent-blue: #3b82f6;
  --accent-purple: #a78bfa;
  --accent-green: #34d399;
  --accent-yellow: #fbbf24;
  --accent-red: #f87171;
  --accent-orange: #fb923c;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --bit-on: #22d3ee;
  --bit-off: #334155;
  --bit-changed: #fbbf24;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans SC', sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}
.mono { font-family: 'JetBrains Mono', monospace; }
.glass {
  background: rgba(30,41,59,0.7);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(148,163,184,0.12);
}
.glass-hover:hover {
  border-color: rgba(34,211,238,0.3);
  box-shadow: 0 0 20px rgba(34,211,238,0.08);
}

/* Header */
.header-gradient {
  background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(167,139,250,0.15), rgba(34,211,238,0.1));
}

/* Bit Cell */
.bit-cell {
  width: 44px; height: 52px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  border-radius: 8px;
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-family: 'JetBrains Mono', monospace;
  font-size: 20px; font-weight: 700;
  position: relative;
}
.bit-cell.on { background: rgba(34,211,238,0.2); color: var(--bit-on); border: 1.5px solid var(--bit-on); box-shadow: 0 0 12px rgba(34,211,238,0.25); }
.bit-cell.off { background: var(--bit-off); color: var(--text-secondary); border: 1.5px solid rgba(148,163,184,0.15); }
.bit-cell.changed { background: rgba(251,191,36,0.2); color: var(--bit-changed); border: 1.5px solid var(--bit-changed); box-shadow: 0 0 12px rgba(251,191,36,0.25); animation: bitPulse 0.6s ease-out; }
.bit-cell.highlight-c { background: rgba(251,113,133,0.2); color: var(--accent-red); border: 1.5px solid var(--accent-red); box-shadow: 0 0 12px rgba(251,113,133,0.25); }
.bit-cell.highlight-carry { background: rgba(52,211,153,0.2); color: var(--accent-green); border: 1.5px solid var(--accent-green); box-shadow: 0 0 12px rgba(52,211,153,0.25); }
.bit-cell.highlight-ones { background: rgba(167,139,250,0.2); color: var(--accent-purple); border: 1.5px solid var(--accent-purple); box-shadow: 0 0 12px rgba(167,139,250,0.25); }
.bit-index { font-size: 9px; color: var(--text-secondary); margin-top: 2px; }
@keyframes bitPulse {
  0% { transform: scale(1.3); } 100% { transform: scale(1); }
}
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.step-animate { animation: fadeSlideIn 0.4s ease-out; }

/* Step Indicator */
.step-dot {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 14px;
  transition: all 0.3s;
}
.step-dot.active { background: var(--accent-cyan); color: var(--bg-dark); box-shadow: 0 0 20px rgba(34,211,238,0.4); }
.step-dot.done { background: var(--accent-green); color: var(--bg-dark); }
.step-dot.pending { background: var(--bg-card2); color: var(--text-secondary); }
.step-line { height: 2px; flex: 1; transition: background 0.3s; }
.step-line.done { background: var(--accent-green); }
.step-line.pending { background: var(--bg-card2); }

/* Buttons */
.btn-primary {
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
  color: #fff; font-weight: 600; padding: 10px 24px;
  border-radius: 10px; border: none; cursor: pointer;
  transition: all 0.2s; font-size: 14px;
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(34,211,238,0.3); }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-secondary {
  background: var(--bg-card2); color: var(--text-primary);
  font-weight: 500; padding: 10px 24px;
  border-radius: 10px; border: 1px solid rgba(148,163,184,0.15);
  cursor: pointer; transition: all 0.2s; font-size: 14px;
}
.btn-secondary:hover { border-color: rgba(148,163,184,0.3); }

/* Input */
.num-input {
  background: var(--bg-dark); border: 1.5px solid rgba(148,163,184,0.2);
  border-radius: 10px; color: var(--text-primary); padding: 10px 16px;
  font-family: 'JetBrains Mono', monospace; font-size: 16px;
  width: 120px; text-align: center; outline: none; transition: border-color 0.2s;
}
.num-input:focus { border-color: var(--accent-cyan); }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-card2); border-radius: 3px; }

/* Tag */
.tag {
  display: inline-block; padding: 2px 10px; border-radius: 6px;
  font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
}

/* Timeline */
.timeline-item { position: relative; padding-left: 28px; }
.timeline-item::before {
  content: ''; position: absolute; left: 8px; top: 28px;
  width: 2px; height: calc(100% - 20px); background: var(--bg-card2);
}
.timeline-item:last-child::before { display: none; }
.timeline-dot {
  position: absolute; left: 2px; top: 6px;
  width: 14px; height: 14px; border-radius: 50%;
  border: 2px solid var(--accent-cyan); background: var(--bg-dark);
}

/* tooltip */
.formula-box {
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(34,211,238,0.2);
  border-radius: 8px; padding: 8px 14px;
}

.tab-btn {
  padding: 8px 18px; border-radius: 8px;
  font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all 0.2s;
  border: 1px solid transparent;
}
.tab-btn.active {
  background: rgba(34,211,238,0.15);
  border-color: rgba(34,211,238,0.3);
  color: var(--accent-cyan);
}
.tab-btn:not(.active) {
  color: var(--text-secondary);
}
.tab-btn:not(.active):hover {
  color: var(--text-primary);
  background: rgba(148,163,184,0.08);
}
</style>
</head>
<body>

<div x-data="gosperApp()" x-init="init()">

  <!-- Header -->
  <header class="header-gradient py-6 px-6 border-b border-white/5">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-2xl font-bold flex items-center gap-3">
            <span class="text-3xl">âš¡</span>
            <span style="background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">
              Gosper's Hack
            </span>
            <span class="text-lg font-normal text-slate-400">â€” åŒ popcount ä¸‹ä¸€ä¸ªæ•°</span>
          </h1>
          <p class="text-sm text-slate-400 mt-1 ml-11">MIT HAKMEM Item 175 Â· Bill Gosper Â· 1972</p>
        </div>
        <div class="flex items-center gap-3">
          <label class="text-sm text-slate-400">è¾“å…¥ xï¼š</label>
          <input type="number" class="num-input" x-model.number="inputX" min="1" max="255"
                 @keydown.enter="startDemo()" :disabled="isAnimating">
          <button class="btn-primary" @click="startDemo()" :disabled="isAnimating">
            ğŸš€ å¼€å§‹æ¼”ç¤º
          </button>
          <button class="btn-secondary" @click="autoPlay()" :disabled="isAnimating || currentStep >= 4">
            â–¶ è‡ªåŠ¨æ’­æ”¾
          </button>
          <button class="btn-secondary" @click="resetDemo()">â†º é‡ç½®</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-6 flex flex-col gap-6">

    <!-- Step Progress Bar -->
    <div class="glass rounded-2xl p-5">
      <div class="flex items-center gap-2">
        <template x-for="(s, i) in steps" :key="i">
          <div class="flex items-center flex-1 last:flex-none">
            <div class="flex flex-col items-center gap-1 relative z-10 cursor-pointer" @click="jumpToStep(i)">
              <div class="step-dot"
                   :class="i < currentStep ? 'done' : i === currentStep ? 'active' : 'pending'"
                   x-text="i + 1"></div>
              <span class="text-xs mt-1 whitespace-nowrap"
                    :class="i <= currentStep ? 'text-cyan-300' : 'text-slate-500'"
                    x-text="s.shortName"></span>
            </div>
            <div x-show="i < steps.length - 1" class="step-line mx-2"
                 :class="i < currentStep ? 'done' : 'pending'"></div>
          </div>
        </template>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left: Binary Visualization -->
      <div class="lg:col-span-2 flex flex-col gap-5">

        <!-- Binary Display Panel -->
        <div class="glass rounded-2xl p-6">
          <h3 class="text-sm font-semibold text-slate-400 mb-4 flex items-center gap-2">
            <span>ğŸ”¢</span> äºŒè¿›åˆ¶ä½è§†å›¾ <span class="text-xs text-slate-500">(8-bit)</span>
          </h3>
          <div class="flex flex-col gap-3">
            <!-- x -->
            <div class="flex items-center gap-3">
              <div class="w-24 text-right">
                <span class="mono text-sm text-cyan-300 font-bold">x</span>
                <span class="mono text-xs text-slate-500 ml-1" x-text="'= ' + x"></span>
              </div>
              <div class="flex gap-1.5">
                <template x-for="(b, i) in getBits(x)" :key="'x'+i">
                  <div class="bit-cell" :class="b === 1 ? 'on' : 'off'">
                    <span x-text="b"></span>
                    <span class="bit-index" x-text="7 - i"></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- c (Step1+) -->
            <template x-if="currentStep >= 1">
              <div class="flex items-center gap-3 step-animate">
                <div class="w-24 text-right">
                  <span class="mono text-sm font-bold" style="color:var(--accent-red)">c</span>
                  <span class="mono text-xs text-slate-500 ml-1" x-text="'= ' + c"></span>
                </div>
                <div class="flex gap-1.5">
                  <template x-for="(b, i) in getBits(c)" :key="'c'+i">
                    <div class="bit-cell" :class="b === 1 ? 'highlight-c' : 'off'">
                      <span x-text="b"></span>
                      <span class="bit-index" x-text="7 - i"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>

            <!-- r (Step2+) -->
            <template x-if="currentStep >= 2">
              <div class="flex items-center gap-3 step-animate">
                <div class="w-24 text-right">
                  <span class="mono text-sm font-bold" style="color:var(--accent-green)">r</span>
                  <span class="mono text-xs text-slate-500 ml-1" x-text="'= ' + r"></span>
                </div>
                <div class="flex gap-1.5">
                  <template x-for="(b, i) in getBits(r)" :key="'r'+i">
                    <div class="bit-cell" :class="getCarryClass(i)">
                      <span x-text="b"></span>
                      <span class="bit-index" x-text="7 - i"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>

            <!-- ones (Step3+) -->
            <template x-if="currentStep >= 3">
              <div class="flex items-center gap-3 step-animate">
                <div class="w-24 text-right">
                  <span class="mono text-sm font-bold" style="color:var(--accent-purple)">ones</span>
                  <span class="mono text-xs text-slate-500 ml-1" x-text="'= ' + ones"></span>
                </div>
                <div class="flex gap-1.5">
                  <template x-for="(b, i) in getBits(ones)" :key="'o'+i">
                    <div class="bit-cell" :class="b === 1 ? 'highlight-ones' : 'off'">
                      <span x-text="b"></span>
                      <span class="bit-index" x-text="7 - i"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>

            <!-- result (Step4) -->
            <template x-if="currentStep >= 4">
              <div class="flex items-center gap-3 step-animate">
                <div class="w-24 text-right">
                  <span class="mono text-sm font-bold" style="color:var(--accent-yellow)">result</span>
                  <span class="mono text-xs text-slate-500 ml-1" x-text="'= ' + result"></span>
                </div>
                <div class="flex gap-1.5">
                  <template x-for="(b, i) in getBits(result)" :key="'res'+i">
                    <div class="bit-cell" :class="getResultClass(i)">
                      <span x-text="b"></span>
                      <span class="bit-index" x-text="7 - i"></span>
                    </div>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Step Detail Card -->
        <div class="glass rounded-2xl p-6 glass-hover" x-show="currentStep >= 0 && currentStep <= 4">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl flex-shrink-0"
                 :style="'background:' + (currentStepData?.bg || 'var(--bg-card2)')">
              <span x-text="currentStepData?.icon || 'ğŸ”§'"></span>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="font-bold text-lg" x-text="currentStepData?.title || ''"></h3>
                <div class="formula-box mono text-sm" x-html="currentStepData?.formula || ''"></div>
              </div>
              <p class="text-slate-300 text-sm leading-relaxed" x-html="currentStepData?.desc || ''"></p>
              <div class="mt-3 p-3 rounded-lg bg-slate-800/50 border border-slate-700/50" x-show="currentStepData?.detail">
                <p class="text-xs text-slate-400 leading-relaxed mono" x-html="currentStepData?.detail || ''"></p>
              </div>
            </div>
          </div>
          <div class="flex justify-end mt-4 gap-3">
            <button class="btn-secondary text-sm" @click="prevStep()" :disabled="currentStep <= 0 || isAnimating">
              â† ä¸Šä¸€æ­¥
            </button>
            <button class="btn-primary text-sm" @click="nextStep()" :disabled="currentStep >= 4 || isAnimating">
              ä¸‹ä¸€æ­¥ â†’
            </button>
          </div>
        </div>

        <!-- Combination Traversal Demo -->
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-slate-400 flex items-center gap-2">
              <span>ğŸ¯</span> ç»„åˆéå†æ¼”ç¤º â€” æšä¸¾æ‰€æœ‰ C(n, k) ç»„åˆ
            </h3>
            <div class="flex items-center gap-2">
              <label class="text-xs text-slate-500">n=</label>
              <input type="number" class="num-input" style="width:60px;padding:6px 8px;font-size:13px;" x-model.number="comboN" min="3" max="8">
              <label class="text-xs text-slate-500">k=</label>
              <input type="number" class="num-input" style="width:60px;padding:6px 8px;font-size:13px;" x-model.number="comboK" min="1" :max="comboN">
              <button class="btn-primary text-xs" style="padding:6px 14px;" @click="runComboDemo()" :disabled="comboRunning">
                ç”Ÿæˆå…¨éƒ¨ç»„åˆ
              </button>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 max-h-48 overflow-y-auto pr-2" x-show="combos.length > 0">
            <template x-for="(cb, i) in combos" :key="i">
              <div class="flex items-center gap-1 px-2 py-1 rounded-lg text-xs mono"
                   :class="i === comboHighlight ? 'bg-cyan-500/20 border border-cyan-500/40' : 'bg-slate-800/50 border border-slate-700/30'"
                   :style="'animation-delay:' + (i*30) + 'ms'"
                   style="animation: fadeSlideIn 0.3s ease-out both;">
                <span class="text-slate-500 mr-1" x-text="'#' + (i+1)"></span>
                <span class="text-cyan-300" x-text="formatBin(cb, comboN)"></span>
                <span class="text-slate-500">=</span>
                <span class="text-yellow-300" x-text="cb"></span>
                <span class="text-slate-600 ml-1" x-text="'â†’ {' + getSetRepr(cb, comboN) + '}'"></span>
              </div>
            </template>
          </div>
          <div x-show="combos.length === 0" class="text-center text-slate-500 text-sm py-6">
            ç‚¹å‡»ã€Œç”Ÿæˆå…¨éƒ¨ç»„åˆã€æŸ¥çœ‹ Gosper's Hack éå† C(n,k) çš„å®Œæ•´åºåˆ—
          </div>
          <div x-show="combos.length > 0" class="mt-3 flex items-center gap-4 text-xs text-slate-400">
            <span>æ€»è®¡ <strong class="text-cyan-300" x-text="combos.length"></strong> ä¸ªç»„åˆ</span>
            <span>popcount = <strong class="text-green-300" x-text="comboK"></strong></span>
            <span>æ¯æ­¥ O(1)ï¼Œå…± O(C(<span x-text="comboN"></span>,<span x-text="comboK"></span>))</span>
          </div>
        </div>
      </div>

      <!-- Right: Info Panels -->
      <div class="flex flex-col gap-5">

        <!-- Popcount Verification -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-sm font-semibold text-slate-400 mb-3 flex items-center gap-2">
            <span>âœ…</span> Popcount éªŒè¯
          </h3>
          <div class="flex items-center justify-center gap-6 py-3">
            <div class="text-center">
              <div class="text-3xl font-bold text-cyan-300 mono" x-text="popcount(x)"></div>
              <div class="text-xs text-slate-500 mt-1">x çš„ 1 çš„ä¸ªæ•°</div>
            </div>
            <div class="text-2xl" x-text="currentStep >= 4 ? (popcount(x) === popcount(result) ? 'âœ…' : 'âŒ') : 'â³'"></div>
            <div class="text-center">
              <div class="text-3xl font-bold mono"
                   :class="currentStep >= 4 ? 'text-yellow-300' : 'text-slate-600'"
                   x-text="currentStep >= 4 ? popcount(result) : '?'"></div>
              <div class="text-xs text-slate-500 mt-1">result çš„ 1 çš„ä¸ªæ•°</div>
            </div>
          </div>
        </div>

        <!-- Performance Chart -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-sm font-semibold text-slate-400 mb-3 flex items-center gap-2">
            <span>ğŸ“Š</span> æ€§èƒ½å¯¹æ¯”
          </h3>
          <div id="perfChart" style="width:100%;height:200px;"></div>
        </div>

        <!-- History / Insights tabs -->
        <div class="glass rounded-2xl p-5">
          <div class="flex items-center gap-2 mb-4">
            <button class="tab-btn" :class="infoTab === 'history' ? 'active' : ''" @click="infoTab='history'">ğŸ“œ å†å²æ¸Šæº</button>
            <button class="tab-btn" :class="infoTab === 'analysis' ? 'active' : ''" @click="infoTab='analysis'">ğŸ”¬ æŠ€æœ¯å‰–æ</button>
          </div>

          <div x-show="infoTab === 'history'" class="text-sm text-slate-300 leading-relaxed space-y-3">
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <p><strong class="text-cyan-300">1972 Â· MIT AI Lab</strong></p>
              <p class="text-xs text-slate-400 mt-1">Bill Gosper åœ¨ HAKMEMï¼ˆMemo 239ï¼‰ä¸­æå‡ºæ­¤ç®—æ³•ã€‚é‚£ä¸ªå¹´ä»£çš„é»‘å®¢ä»¬ç—´è¿·äºç”¨æœ€å°‘çš„ PDP-10 æŒ‡ä»¤å®Œæˆæœ€å¤æ‚çš„äº‹ã€‚è¿™ä¸æ˜¯"ä¼˜åŒ–"ï¼Œè¿™æ˜¯ä¸€ç§ä¿¡ä»° â€”â€” åœ¨ç¡¬ä»¶èµ„æºæåº¦åŒ®ä¹æ—¶ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯æˆ˜åœºä¸Šçš„å­å¼¹ã€‚</p>
            </div>
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <p><strong class="text-green-300">æœ¬è´¨</strong></p>
              <p class="text-xs text-slate-400 mt-1">è¡¥ç çš„æ•°å­¦ç»“æ„è¢« Gosper å½“ä½œä¸€å°ç²¾å¯†çš„é½¿è½®ç»„æ¥ä½¿ç”¨ï¼š<code class="text-cyan-200">x & (-x)</code> æå–æœ€ä½ä½çš„ 1 â€”â€” è¿™ä¸æ˜¯æŠ€å·§ï¼Œè€Œæ˜¯è¡¥ç ç³»ç»Ÿ"è¿›ä½é“¾æº¢å‡º"è¿™ä¸€ç‰©ç†ç°è±¡çš„ç›´æ¥æ˜ å°„ã€‚å®ƒæŠŠç¡¬ä»¶åŠ æ³•å™¨çš„è¿›ä½ä¼ æ’­è¡Œä¸ºç›´æ¥æš´éœ²ä¸ºå¯ç¼–ç¨‹çš„é€»è¾‘ã€‚</p>
            </div>
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <p><strong class="text-purple-300">ä¼ æ‰¿</strong></p>
              <p class="text-xs text-slate-400 mt-1">Henry Warren åœ¨ã€ŠHacker's Delightã€‹ä¸­è¯¦ç»†è®°è½½äº†æ­¤ç®—æ³•ã€‚ç°ä»£ CPU æä¾›äº† BLSIï¼ˆæå–æœ€ä½è®¾å®šä½ï¼‰ç­‰æŒ‡ä»¤ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æŠŠ Gosper çš„æ´å¯Ÿå›ºåŒ–åˆ°ç¡…ç‰‡é‡Œã€‚è½¯ä»¶çš„æè‡´æ€è€ƒï¼Œæœ€ç»ˆå˜æˆäº†ç¡¬ä»¶çš„æ ‡é…ã€‚</p>
            </div>
          </div>

          <div x-show="infoTab === 'analysis'" class="text-sm text-slate-300 leading-relaxed space-y-3">
            <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700/40">
              <p class="font-bold text-yellow-300 text-xs mb-2">ğŸ”§ ä¸ºä»€ä¹ˆéå¾—ç”¨è¿™ç§æ–¹å¼ï¼Ÿ</p>
              <p class="text-xs text-slate-400">æ ¸å¿ƒåœ¨äº<strong>è¡¥ç çš„ä»£æ•°å°é—­æ€§</strong>ã€‚è¡¥ç ä¸åªæ˜¯"è´Ÿæ•°çš„ç¼–ç æ–¹å¼"ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¨¡è¿ç®—ç¾¤ã€‚<code>x & (-x)</code> èƒ½workï¼Œæ˜¯å› ä¸º <code>-x = ~x + 1</code> ä¸­çš„ <code>+1</code> ä¼šå¼•å‘ä»æœ€ä½ä½å¼€å§‹çš„è¿›ä½é“¾ï¼Œæ­£å¥½åœ¨ç¬¬ä¸€ä¸ª 1 å¤„åœä¸‹ã€‚è¿™æ˜¯è¿›ä½é“¾ç‰©ç†è¡Œä¸ºçš„æ•°å­¦æ˜ å°„ï¼Œä¸æ˜¯å·§åˆã€‚</p>
            </div>
            <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700/40">
              <p class="font-bold text-cyan-300 text-xs mb-2">âš¡ æ›¿ä»£æ–¹æ¡ˆï¼Ÿ</p>
              <p class="text-xs text-slate-400">å¯ä»¥ç”¨æŸ¥è¡¨æ³•ï¼ˆé¢„ç”Ÿæˆæ‰€æœ‰åŒ popcount çš„æ•°æ’åºååšäºŒåˆ†æŸ¥æ‰¾ï¼‰ï¼Œä½†å†…å­˜å¼€é”€çˆ†ç‚¸ï¼›å¯ä»¥ç”¨å¾ªç¯é€ä¸ªè¯•æ¢ <code>while(popcount(++x) != k)</code>ï¼Œä½†è¿™å¯èƒ½éœ€è¦æ‰«ææ•°ç™¾ä¸‡ä¸ªæ— æ•ˆæ•°ã€‚Gosper çš„é­”åŠ›åœ¨äºï¼šå®ƒæŠŠä¸€ä¸ª"æœç´¢é—®é¢˜"å˜æˆäº†çº¯ç²¹çš„"ä»£æ•°è®¡ç®—"ã€‚æœç´¢æ˜¯ O(é—´è·)ï¼Œè®¡ç®—æ˜¯ O(1)ã€‚</p>
            </div>
            <div class="p-3 rounded-lg bg-slate-800/50 border border-slate-700/40">
              <p class="font-bold text-green-300 text-xs mb-2">ğŸŒ å¯æ¨å¹¿æ€§</p>
              <p class="text-xs text-slate-400">è¿™ç§"ä»æœ€ä½æœ‰æ•ˆä½æå–ç‰¹å¾ â†’ åˆ©ç”¨è¿›ä½ä¼ æ’­æ”¹å˜çŠ¶æ€ â†’ å½’ä¸€åŒ–è¡¥å¿"çš„ä¸‰æ®µå¼èŒƒå¼ï¼Œåœ¨ä½è¿ç®—é¢†åŸŸåå¤å‡ºç°ã€‚å¦‚ SNOOBï¼ˆSame Number of One Bitsï¼‰ã€å­é›†éå† <code>s = (s - x) & x</code> ç­‰ã€‚æœ¬è´¨æ˜¯åŒä¸€ç§æ€ç»´ï¼š<strong>æŠŠåŠ æ³•å™¨çš„è¿›ä½é“¾å½“ä½œå…è´¹çš„"æœç´¢å¼•æ“"æ¥ä½¿ç”¨</strong>ã€‚</p>
            </div>
            <div class="p-3 rounded-lg bg-slate-800/50 border border-amber-700/40">
              <p class="font-bold text-orange-300 text-xs mb-2">ğŸ’¡ å¯ç¤º</p>
              <p class="text-xs text-slate-400">è¿™æ®µä»£ç å†™äº 1972 å¹´ã€‚åŠä¸ªä¸–çºªåçš„ CPU æ¶æ„å¸ˆä»¬æŠŠ <code>BLSI</code>ã€<code>BLSR</code>ã€<code>BLSMSK</code> åšæˆäº†ç¡¬ä»¶æŒ‡ä»¤ï¼ˆBMI1 æŒ‡ä»¤é›†ï¼‰ã€‚è¿™è¯´æ˜ä»€ä¹ˆï¼Ÿè¯´æ˜çœŸæ­£æ·±åˆ»çš„ç®—æ³•æ´å¯Ÿä¸ä¼šè¢«æ—¶ä»£æ·˜æ±° â€”â€” å®ƒä¼š<strong>ä¸‹æ²‰åˆ°ç¡¬ä»¶å±‚</strong>ï¼Œä»"èªæ˜çš„è½¯ä»¶æŠ€å·§"å˜æˆ"ç†æ‰€åº”å½“çš„ç‰©ç†ç”µè·¯"ã€‚è¿™æ‰æ˜¯ hack çš„æœ€é«˜å¢ƒç•Œï¼šé»‘è¿›ç¡…ç‰‡é‡Œã€‚</p>
            </div>
          </div>
        </div>

        <!-- Quick Reference -->
        <div class="glass rounded-2xl p-5">
          <h3 class="text-sm font-semibold text-slate-400 mb-3 flex items-center gap-2">
            <span>ğŸ“‹</span> å®Œæ•´ä»£ç 
          </h3>
          <pre class="mono text-xs leading-relaxed p-3 rounded-lg bg-slate-900/80 border border-slate-700/40 overflow-x-auto"><code><span style="color:var(--accent-cyan)">unsigned</span> gosper_next(<span style="color:var(--accent-cyan)">unsigned</span> x) {
  <span style="color:var(--accent-red)">unsigned</span> c = x & (-x);       <span style="color:var(--text-secondary)">// æœ€ä½ä½1</span>
  <span style="color:var(--accent-green)">unsigned</span> r = x + c;          <span style="color:var(--text-secondary)">// è¿›ä½ä¼ æ’­</span>
  <span style="color:var(--accent-purple)">unsigned</span> ones = ((r^x)/c)>>2; <span style="color:var(--text-secondary)">// è¡¥å›1</span>
  <span style="color:var(--accent-yellow)">return</span> r | ones;             <span style="color:var(--text-secondary)">// åˆå¹¶</span>
}</code></pre>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="tag" style="background:rgba(34,211,238,0.15);color:var(--accent-cyan);">O(1) æ—¶é—´</span>
            <span class="tag" style="background:rgba(52,211,153,0.15);color:var(--accent-green);">O(1) ç©ºé—´</span>
            <span class="tag" style="background:rgba(251,191,36,0.15);color:var(--accent-yellow);">æ— åˆ†æ”¯</span>
            <span class="tag" style="background:rgba(167,139,250,0.15);color:var(--accent-purple);">ä½è¿ç®—</span>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
function gosperApp() {
  return {
    inputX: 28,
    x: 28,
    c: 0, r: 0, ones: 0, result: 0,
    currentStep: -1,
    isAnimating: false,
    infoTab: 'history',
    comboN: 5,
    comboK: 3,
    combos: [],
    comboHighlight: -1,
    comboRunning: false,

    steps: [
      { shortName: 'æå–æœ€ä½1', icon: 'ğŸ¯', title: 'Step 1: æå–æœ€ä½ä½çš„ 1', bg: 'rgba(248,113,113,0.15)',
        formula: '<span style="color:var(--accent-red)">c</span> = x & (-x)',
        desc: 'åˆ©ç”¨è¡¥ç ç‰¹æ€§æå– x ä¸­æœ€å³ä¾§ï¼ˆæœ€ä½ä½ï¼‰çš„ 1ã€‚è¿™ä¸ªä½å°±æ˜¯è¿›ä½çš„<strong style="color:var(--accent-red)">èµ·çˆ†ç‚¹</strong>ã€‚',
        detail: ''
      },
      { shortName: 'è¿›ä½ä¼ æ’­', icon: 'ğŸ’¥', title: 'Step 2: è¿›ä½ä¼ æ’­', bg: 'rgba(52,211,153,0.15)',
        formula: '<span style="color:var(--accent-green)">r</span> = x + c',
        desc: 'å°†æœ€ä½ä½ 1 åŠ å› xï¼Œè§¦å‘è¿é”è¿›ä½ååº”ã€‚æœ€å³ä¾§è¿ç»­çš„ 1 å…¨éƒ¨è¢«<strong style="color:var(--accent-green)">ç¿»è½¬ä¸º 0</strong>ï¼Œå·¦è¾¹ç¬¬ä¸€ä¸ª 0 å˜æˆ 1ã€‚',
        detail: ''
      },
      { shortName: 'è®¡ç®—è¡¥1', icon: 'ğŸ”¬', title: 'Step 3: è®¡ç®—éœ€è¦è¡¥å›çš„ 1', bg: 'rgba(167,139,250,0.15)',
        formula: '<span style="color:var(--accent-purple)">ones</span> = ((r^x)/c) >> 2',
        desc: '<code>r^x</code> æ‰¾å‡ºæ‰€æœ‰å˜åŒ–çš„ä½ï¼Œ<code>/c</code> å³ç§»å¯¹é½åˆ°æœ€ä½ä½ï¼Œ<code>>>2</code> æ‰£é™¤å¤šç®—çš„ 2 ä¸ª 1ã€‚ç»“æœå°±æ˜¯éœ€è¦<strong style="color:var(--accent-purple)">è¡¥å›åˆ°æœ€å³ä¾§</strong>çš„ 1ã€‚',
        detail: ''
      },
      { shortName: 'åˆå¹¶ç»“æœ', icon: 'âœ¨', title: 'Step 4: åˆå¹¶æœ€ç»ˆç»“æœ', bg: 'rgba(251,191,36,0.15)',
        formula: '<span style="color:var(--accent-yellow)">result</span> = r | ones',
        desc: 'é«˜ä½éƒ¨åˆ†ï¼ˆrï¼‰ä¸ä½ä½è¡¥å›çš„ 1ï¼ˆonesï¼‰æŒ‰ä½æˆ–åˆå¹¶ã€‚å¾—åˆ°<strong style="color:var(--accent-yellow)">ä¸‹ä¸€ä¸ªåŒ popcount çš„æ•°</strong>ï¼',
        detail: ''
      }
    ],

    get currentStepData() {
      if (this.currentStep < 0 || this.currentStep > 3) {
        return { icon: 'ğŸš€', title: 'å‡†å¤‡å°±ç»ª', bg: 'var(--bg-card2)',
                 formula: '', desc: 'è¾“å…¥ä¸€ä¸ªæ•°ï¼ˆ1~255ï¼‰ï¼Œç‚¹å‡»ã€Œå¼€å§‹æ¼”ç¤ºã€é€æ­¥æŸ¥çœ‹ Gosper\'s Hack çš„è¿ä½œè¿‡ç¨‹ã€‚', detail: '' };
      }
      let s = {...this.steps[this.currentStep]};
      s.detail = this.getStepDetail(this.currentStep);
      return s;
    },

    init() {
      this.$nextTick(() => this.initChart());
    },

    getBits(n) {
      let bits = [];
      for (let i = 7; i >= 0; i--) bits.push((n >> i) & 1);
      return bits;
    },

    popcount(n) {
      let count = 0;
      while (n) { count += n & 1; n >>= 1; }
      return count;
    },

    getCarryClass(i) {
      let xBit = (this.x >> (7 - i)) & 1;
      let rBit = (this.r >> (7 - i)) & 1;
      if (xBit !== rBit) return 'changed';
      return rBit === 1 ? 'highlight-carry' : 'off';
    },

    getResultClass(i) {
      let rBit = (this.r >> (7 - i)) & 1;
      let oBit = (this.ones >> (7 - i)) & 1;
      if (oBit === 1) return 'highlight-ones';
      if (rBit === 1) return 'highlight-carry';
      return 'off';
    },

    getStepDetail(step) {
      const bin = (n) => n.toString(2).padStart(8, '0');
      if (step === 0) {
        let nx = (this.x & 0xFF) >>> 0;
        let negX = ((-this.x) & 0xFF) >>> 0;
        return `x &nbsp;&nbsp;= ${bin(nx)}<br>-x &nbsp;= ${bin(negX)} &nbsp;(è¡¥ç å–å+1)<br>c &nbsp;&nbsp;= ${bin(this.c)} &nbsp;â†’ æœ€ä½ä½çš„ 1 åœ¨ bit ${Math.log2(this.c)}`;
      }
      if (step === 1) {
        return `x &nbsp;&nbsp;= ${bin(this.x)}<br>c &nbsp;&nbsp;= ${bin(this.c)}<br>r &nbsp;&nbsp;= ${bin(this.r & 0xFF)} &nbsp;â†’ è¿ç»­1åŒºå—ç¿»è½¬ï¼Œé«˜ä½è¿›1`;
      }
      if (step === 2) {
        let rxor = ((this.r ^ this.x) & 0xFF) >>> 0;
        let divided = (rxor / this.c) >>> 0;
        return `r^x &nbsp;= ${bin(rxor)} &nbsp;(å˜åŒ–çš„ä½)<br>/c &nbsp;&nbsp;= ${bin(divided & 0xFF)} &nbsp;(å³ç§»å¯¹é½)<br>>>2 &nbsp;= ${bin(this.ones & 0xFF)} &nbsp;(è¡¥å› ${this.popcount(this.ones)} ä¸ª1)`;
      }
      if (step === 3) {
        return `r &nbsp;&nbsp;&nbsp;&nbsp;= ${bin(this.r & 0xFF)}<br>ones &nbsp;= ${bin(this.ones & 0xFF)}<br>r|ones= ${bin(this.result & 0xFF)} â†’ <strong>${this.result}</strong> (popcount=${this.popcount(this.result)})`;
      }
      return '';
    },

    startDemo() {
      this.x = Math.max(1, Math.min(255, this.inputX || 28));
      this.inputX = this.x;
      this.c = 0; this.r = 0; this.ones = 0; this.result = 0;
      this.currentStep = 0;
      this.computeStep(0);
      this.updateChart();
    },

    computeStep(step) {
      if (step >= 0) this.c = this.x & (-this.x);
      if (step >= 1) this.r = this.x + this.c;
      if (step >= 2) this.ones = (((this.r ^ this.x) / this.c) >> 2);
      if (step >= 3) this.result = this.r | this.ones;
    },

    nextStep() {
      if (this.currentStep >= 4) return;
      this.currentStep++;
      this.computeStep(this.currentStep - 1);
    },

    prevStep() {
      if (this.currentStep <= 0) return;
      this.currentStep--;
      if (this.currentStep === 0) { this.c = this.x & (-this.x); this.r = 0; this.ones = 0; this.result = 0; }
      else this.computeStep(this.currentStep - 1);
    },

    jumpToStep(i) {
      if (this.isAnimating) return;
      this.currentStep = i;
      this.computeStep(i - 1);
    },

    async autoPlay() {
      this.isAnimating = true;
      this.startDemo();
      for (let i = 1; i <= 4; i++) {
        await new Promise(r => setTimeout(r, 900));
        this.nextStep();
      }
      this.isAnimating = false;
    },

    resetDemo() {
      this.currentStep = -1;
      this.c = 0; this.r = 0; this.ones = 0; this.result = 0;
      this.combos = [];
      this.comboHighlight = -1;
    },

    formatBin(n, bits) {
      return n.toString(2).padStart(bits, '0');
    },

    getSetRepr(n, bits) {
      let parts = [];
      for (let i = 0; i < bits; i++) {
        if ((n >> i) & 1) parts.push(i);
      }
      return parts.join(',');
    },

    async runComboDemo() {
      this.comboRunning = true;
      this.combos = [];
      this.comboHighlight = -1;
      let n = Math.max(3, Math.min(8, this.comboN));
      let k = Math.max(1, Math.min(n, this.comboK));
      this.comboN = n;
      this.comboK = k;
      let x = (1 << k) - 1;
      let limit = 1 << n;
      let idx = 0;
      while (x < limit) {
        this.combos.push(x);
        this.comboHighlight = idx;
        await new Promise(r => setTimeout(r, Math.max(20, 120 - idx * 2)));
        let c = x & (-x);
        let r = x + c;
        let ones = (((r ^ x) / c) >> 2);
        x = r | ones;
        idx++;
      }
      this.comboRunning = false;
    },

    initChart() {
      let chart = echarts.init(document.getElementById('perfChart'), 'dark');
      chart.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { top: 0, textStyle: { fontSize: 10, color: '#94a3b8' }, itemWidth: 12, itemHeight: 8 },
        grid: { top: 30, bottom: 24, left: 44, right: 12 },
        xAxis: {
          type: 'category',
          data: ['8-bit','16-bit','32-bit','64-bit'],
          axisLabel: { fontSize: 10, color: '#64748b' },
          axisLine: { lineStyle: { color: '#334155' } }
        },
        yAxis: {
          type: 'log',
          name: 'æ“ä½œæ¬¡æ•°',
          nameTextStyle: { fontSize: 9, color: '#64748b' },
          axisLabel: { fontSize: 9, color: '#64748b' },
          splitLine: { lineStyle: { color: '#1e293b' } }
        },
        series: [
          { name: 'Gosper O(1)', type: 'bar', data: [5,5,5,5], itemStyle: { color: '#22d3ee' }, barWidth: 16 },
          { name: 'æš´åŠ›æœç´¢(avg)', type: 'bar', data: [20, 500, 130000, 5e8], itemStyle: { color: '#f87171' }, barWidth: 16 }
        ]
      });
      window.addEventListener('resize', () => chart.resize());
      this._chart = chart;
    },

    updateChart() {
      // Chart stays static; represents general performance comparison
    }
  };
}
</script>

<script>window.parent.postMessage({ action: "ready" }, "*"); 
 
window.console = new Proxy(console, {
  get(target, prop) {
    if (['log', 'warn', 'error'].includes(prop)) {
      return new Proxy(target[prop], {
        apply(fn, thisArg, args) {
          fn.apply(thisArg, args);
          window.parent.postMessage({ action: 'console', 
            type: prop, 
            args: args.map((arg) => {
              try {
                return JSON.stringify(arg).replace(/^["']|["']$/g, '');
              } catch (e) {
                return arg;
              }
            }) 
          }, '*');
        }
      });
    }
    return target[prop];
  }
});
</script></body>
</html>
