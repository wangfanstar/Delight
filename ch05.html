
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ch.05 â€” ä½è®¡æ•° | Hacker's Delight</title>
<link rel="stylesheet" href="tailwind.css"/>
<script src="echarts.min.js"></script>
<script src="alpine.min.js" defer></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@300;400;600;700;900&display=swap');
:root{
  --g:#00ff88;--b:#00d4ff;--p:#b14fff;--o:#ff8c00;--r:#ff4466;
  --dark:#050810;--card:#0d1117;--border:rgba(0,255,136,.18);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--dark);color:#e2e8f0;font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;font-size:19px;line-height:1.7;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,136,.008) 2px,rgba(0,255,136,.008) 4px);pointer-events:none;z-index:0;}
canvas#bg{position:fixed;inset:0;z-index:0;pointer-events:none;}
#app{position:relative;z-index:1;}

nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(5,8,16,.92);backdrop-filter:blur(14px);border-bottom:1px solid var(--border);padding:.7rem 2rem;display:flex;align-items:center;justify-content:space-between;}
.nav-logo{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);text-decoration:none;}
.nav-links{display:flex;gap:1.4rem;}
.nav-links a{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:#475569;text-decoration:none;transition:color .2s;}
.nav-links a:hover{color:var(--g);}

#prog{position:fixed;top:0;left:0;height:2px;z-index:200;background:linear-gradient(90deg,var(--g),var(--b),var(--p));transition:width .1s;}

.dot-nav{position:fixed;right:1.4rem;top:50%;transform:translateY(-50%);z-index:50;display:flex;flex-direction:column;gap:.55rem;}
.dot{width:8px;height:8px;border-radius:50%;background:#1e293b;cursor:pointer;transition:all .2s;}
.dot.active{background:var(--g);transform:scale(1.45);box-shadow:0 0 6px var(--g);}
@media(max-width:768px){.dot-nav{display:none;}}
/* â•â•â• å·¦ä¾§ç« èŠ‚å¯¼èˆªæ  â•â•â• */
.sidebar-nav{position:fixed;left:0;top:0;bottom:0;width:180px;z-index:90;background:rgba(5,8,16,.92);backdrop-filter:blur(10px);border-right:1px solid rgba(0,255,136,.12);padding:1rem .5rem;overflow-y:auto;overflow-x:hidden;transition:transform .25s ease;display:flex;flex-direction:column;}
.sidebar-nav::-webkit-scrollbar{width:3px;}
.sidebar-nav::-webkit-scrollbar-thumb{background:#1e293b;border-radius:2px;}
.sidebar-title{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--g);letter-spacing:.08em;padding:.4rem .6rem;border-bottom:1px solid rgba(0,255,136,.15);margin-bottom:.5rem;flex-shrink:0;}
.sidebar-section{margin-bottom:.6rem;display:flex;flex-direction:column;}
.sidebar-section-title{font-family:'JetBrains Mono',monospace;font-size:.58rem;color:#475569;padding:.3rem .6rem;letter-spacing:.05em;flex-shrink:0;}
.sidebar-link{display:block;width:100%;clear:both;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:#64748b;text-decoration:none;padding:.25rem .6rem .25rem 1rem;border-radius:3px;transition:all .15s;position:relative;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sidebar-link:hover{color:var(--g);background:rgba(0,255,136,.06);}
.sidebar-link.active{color:var(--g);background:rgba(0,255,136,.1);}
.sidebar-link.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:2px;height:14px;background:var(--g);border-radius:1px;}
.sidebar-toggle{display:none;position:fixed;left:.5rem;top:.85rem;z-index:95;width:32px;height:32px;background:rgba(5,8,16,.9);border:1px solid rgba(0,255,136,.2);border-radius:4px;color:var(--g);font-size:1.1rem;cursor:pointer;}
@media(max-width:1100px){.sidebar-nav{transform:translateX(-100%);}.sidebar-nav.open{transform:translateX(0);}.sidebar-toggle{display:flex;align-items:center;justify-content:center;}body{padding-left:0!important;}}
body.sidebar-open{padding-left:180px;}
@media(min-width:1101px){body{padding-left:180px;}}

.hero{padding:7rem 2rem 3rem;text-align:center;max-width:900px;margin:0 auto;}
.chapter-badge{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--g);border:1px solid var(--g);padding:.28rem .95rem;border-radius:999px;letter-spacing:.15em;margin-bottom:1.5rem;animation:badge-pulse 2.5s ease-in-out infinite;}
@keyframes badge-pulse{0%,100%{box-shadow:0 0 6px rgba(0,255,136,.35);}50%{box-shadow:0 0 22px rgba(0,255,136,.75);}}
.hero-title{font-size:clamp(2rem,5vw,3.5rem);font-weight:900;background:linear-gradient(135deg,#fff 0%,var(--g) 50%,var(--b) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.15;margin-bottom:.5rem;}
.hero-sub{font-family:'JetBrains Mono',monospace;color:#475569;font-size:.88rem;margin-bottom:1.8rem;}
.hero-desc{color:#94a3b8;font-size:.98rem;line-height:1.88;max-width:720px;margin:0 auto 2rem;}

section{max-width:1100px;margin:0 auto;padding:0 1.5rem 4rem;}
.sec-header{display:flex;align-items:center;gap:.75rem;margin-bottom:1.75rem;}
.sec-num{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--g);background:rgba(0,255,136,.07);border:1px solid rgba(0,255,136,.18);padding:.22rem .55rem;border-radius:4px;white-space:nowrap;}
.sec-title{font-size:1.3rem;font-weight:700;color:#f1f5f9;}
.sec-divider{flex:1;height:1px;background:linear-gradient(90deg,rgba(0,255,136,.28),transparent);}

.card{background:var(--card);border:1px solid #1e293b;border-radius:.75rem;padding:1.4rem;transition:border-color .25s,box-shadow .25s;}
.card:hover{border-color:rgba(0,255,136,.22);box-shadow:0 4px 22px rgba(0,255,136,.06);}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:1.1rem;}
@media(max-width:820px){.grid-2,.grid-3{grid-template-columns:1fr;}}

.code-block{background:#010409;border:1px solid #1e293b;border-radius:.5rem;padding:1.1rem 1.4rem;font-family:'JetBrains Mono',monospace;font-size:.78rem;line-height:1.85;overflow-x:auto;color:#94a3b8;white-space:pre-wrap;}
.code-block .kw{color:var(--p);}
.code-block .num{color:var(--o);}
.code-block .cm{color:#334155;font-style:italic;}
.code-block .fn{color:var(--g);}
.code-block .hi{color:#fff;background:rgba(0,255,136,.1);border-radius:2px;padding:0 3px;}
.code-block .str{color:var(--b);}

.insight{background:rgba(0,255,136,.04);border:1px solid rgba(0,255,136,.14);border-left:3px solid var(--g);border-radius:.5rem;padding:1.15rem 1.4rem;margin-bottom:1.2rem;font-size:.88rem;line-height:1.82;color:#94a3b8;}
.insight strong{color:var(--g);}
.insight .label{font-family:'JetBrains Mono',monospace;font-size:.63rem;color:var(--g);letter-spacing:.1em;display:block;margin-bottom:.4rem;}

.warn-box{background:rgba(255,68,102,.04);border:1px solid rgba(255,68,102,.18);border-left:3px solid var(--r);border-radius:.5rem;padding:1.05rem 1.3rem;font-size:.84rem;line-height:1.78;color:#94a3b8;margin-bottom:1.1rem;}
.warn-box strong{color:var(--r);}

.tag{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:.62rem;padding:.18rem .48rem;border-radius:3px;margin:.12rem;}
.tag-g{background:rgba(0,255,136,.09);color:var(--g);border:1px solid rgba(0,255,136,.18);}
.tag-b{background:rgba(0,212,255,.09);color:var(--b);border:1px solid rgba(0,212,255,.18);}
.tag-p{background:rgba(177,79,255,.09);color:var(--p);border:1px solid rgba(177,79,255,.18);}
.tag-o{background:rgba(255,140,0,.09);color:var(--o);border:1px solid rgba(255,140,0,.18);}
.tag-r{background:rgba(255,68,102,.09);color:var(--r);border:1px solid rgba(255,68,102,.18);}

.tab-nav{display:flex;gap:.4rem;margin-bottom:.9rem;flex-wrap:wrap;}
.tab-btn{font-family:'JetBrains Mono',monospace;font-size:.68rem;padding:.32rem .8rem;border-radius:4px;border:1px solid #1e293b;background:transparent;color:#475569;cursor:pointer;transition:all .2s;}
.tab-btn.active,.tab-btn:hover{border-color:var(--g);color:var(--g);background:rgba(0,255,136,.07);}
.tab-pane{display:none;}.tab-pane.active{display:block;}

.bit-row{display:flex;gap:2px;flex-wrap:wrap;margin:.3rem 0;}
.bit-cell{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:2px;font-family:'JetBrains Mono',monospace;font-size:.65rem;border:1px solid #1e293b;transition:all .25s;cursor:default;}
.bit-cell.one{background:rgba(0,255,136,.22);color:var(--g);border-color:rgba(0,255,136,.4);}
.bit-cell.zero{background:#010409;color:#1e293b;}
.bit-cell.hi{background:rgba(0,212,255,.2);color:var(--b);border-color:rgba(0,212,255,.35);}
.bit-cell.pp{background:rgba(177,79,255,.2);color:var(--p);border-color:rgba(177,79,255,.35);}
.bit-cell.warn{background:rgba(255,68,102,.18);color:var(--r);border-color:rgba(255,68,102,.3);}

.critic-box{background:linear-gradient(135deg,rgba(177,79,255,.05),rgba(0,212,255,.03));border:1px solid rgba(177,79,255,.22);border-radius:.75rem;padding:1.65rem;position:relative;overflow:hidden;}
.critic-box::before{content:'// æ·±åº¦ç‚¹è¯„';font-family:'JetBrains Mono',monospace;font-size:.63rem;color:var(--p);letter-spacing:.1em;display:block;margin-bottom:.9rem;}
.critic-box h3{font-size:1rem;font-weight:700;color:#f1f5f9;margin-bottom:.7rem;}
.critic-item{margin-bottom:1rem;padding-left:.9rem;border-left:2px solid rgba(177,79,255,.28);}
.critic-item .ci-title{font-size:.81rem;font-weight:600;color:var(--p);margin-bottom:.28rem;}
.critic-item p{font-size:.8rem;line-height:1.74;color:#64748b;}

.stat-box{background:#010409;border:1px solid #1e293b;border-radius:.45rem;padding:.7rem 1rem;text-align:center;}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--g);}
.stat-label{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:#334155;letter-spacing:.08em;margin-top:.2rem;}

@keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
.fade-up{opacity:0;animation:fadeUp .5s ease both;}

footer{text-align:center;padding:2.5rem;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:#1e293b;border-top:1px solid #0f172a;}
footer a{color:var(--g);text-decoration:none;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--dark);}
::-webkit-scrollbar-thumb{background:#1e293b;border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:rgba(0,255,136,.28);}

/* popcount æ­¥éª¤å¯è§†åŒ– */
.step-row{display:flex;align-items:center;gap:.5rem;margin:.4rem 0;flex-wrap:wrap;}
.step-label{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:#475569;width:90px;flex-shrink:0;}
.step-eq{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:#334155;margin:0 .25rem;}
.field-group{display:flex;gap:1px;}
.field-sep{width:4px;}
</style>
</head>
<body>
<canvas id="bg"></canvas>
<div id="prog"></div>

<div class="dot-nav" id="dotNav">
  <div class="dot active"  data-sec="hero"    title="é¡¶éƒ¨"></div>
  <div class="dot"         data-sec="pop"     title="Â§5-1 popcount"></div>
  <div class="dot"         data-sec="parity"  title="Â§5-2 å¥‡å¶æ ¡éªŒ"></div>
  <div class="dot"         data-sec="nlz"     title="Â§5-3 å‰å¯¼é›¶"></div>
  <div class="dot"         data-sec="ntz"     title="Â§5-4 å°¾éšé›¶"></div>
  <div class="dot"         data-sec="history" title="å†å²ä¸æ¨ªå‘"></div>
  <div class="dot"         data-sec="critique" title="æ·±åº¦ç‚¹è¯„"></div>
</div>

<nav>
  <a class="nav-logo" href="index.html">â† HACKER'S DELIGHT</a>
  <div class="nav-links">
    <a href="#pop">popcount</a>
    <a href="#parity">å¥‡å¶æ ¡éªŒ</a>
    <a href="#nlz">å‰å¯¼é›¶</a>
    <a href="#ntz">å°¾éšé›¶</a>
    <a href="#history">å†å²</a>
    <a href="#critique">ç‚¹è¯„</a>
  </div>
</nav>

<!-- å·¦ä¾§ç« èŠ‚å¯¼èˆªæ  -->
<button class="sidebar-toggle" @click="sidebarOpen = !sidebarOpen" x-data="{sidebarOpen: false}">
  â˜°
</button>
<nav class="sidebar-nav" :class="sidebarOpen ? 'open' : ''" x-data="{sidebarOpen: false}" @click.away="sidebarOpen = false">
  <div class="sidebar-title">ğŸ“š HACKER'S DELIGHT</div>
  
  <div class="sidebar-section">
    <div class="sidebar-section-title">æ­£æ–‡ç« èŠ‚</div>
    <a href="ch01.html" class="sidebar-link">Ch.01 å¥ å®šåŸºç¡€</a>
    <a href="ch02.html" class="sidebar-link">Ch.02 åŸºç¡€æ“ä½œ</a>
    <a href="ch03.html" class="sidebar-link">Ch.03 2çš„å¹‚è¾¹ç•Œ</a>
    <a href="ch04.html" class="sidebar-link">Ch.04 ç®—æœ¯è¾¹ç•Œ</a>
    <a href="ch05.html" class="sidebar-link active">Ch.05 ä½è®¡æ•°</a>
    <a href="ch06.html" class="sidebar-link">Ch.06 æœç´¢å­—</a>
    <a href="ch07.html" class="sidebar-link">Ch.07 ä½ç¿»è½¬</a>
    <a href="ch08.html" class="sidebar-link">Ch.08 ä½ç½®æ¢</a>
    <a href="ch09.html" class="sidebar-link">Ch.09 å¾ªç¯å†—ä½™æ ¡</a>
    <a href="ch10.html" class="sidebar-link">Ch.10 å¥‡å¶æ ¡éªŒ</a>
    <a href="ch11.html" class="sidebar-link">Ch.11 Grayç </a>
    <a href="ch12.html" class="sidebar-link">Ch.12 Hilbertæ›²çº¿</a>
    <a href="ch13.html" class="sidebar-link">Ch.13 æµ®ç‚¹æ•°</a>
    <a href="ch14.html" class="sidebar-link">Ch.14 å…¬å¼</a>
    <a href="ch15.html" class="sidebar-link">Ch.15 åŸºæ•°è½¬æ¢</a>
    <a href="ch16.html" class="sidebar-link">Ch.16 å¼€æ–¹</a>
    <a href="ch17.html" class="sidebar-link">Ch.17 æµ®ç‚¹å€’æ•°å¼€æ–¹</a>
    <a href="ch18.html" class="sidebar-link">Ch.18 å…¶å®ƒ</a>
  </div>
  
  <div class="sidebar-section">
    <div class="sidebar-section-title">é™„å½•</div>
    <a href="appA.html" class="sidebar-link">App.A è¯æ±‡è¡¨</a>
    <a href="appB.html" class="sidebar-link">App.B æ‘˜è¦</a>
    <a href="appC.html" class="sidebar-link">App.C å‘å±•å²</a>
  </div>
</nav>

<div id="app" x-data="app()" x-init="init()">

<!-- â•â•â• HERO â•â•â• -->
<div class="hero" id="hero">
  <div class="chapter-badge">CHAPTER 05 Â· COUNTING BITS Â· ä½è®¡æ•°</div>
  <h1 class="hero-title fade-up" style="animation-delay:.1s">ä½è®¡æ•°</h1>
  <p class="hero-sub fade-up" style="animation-delay:.2s">// popcount Â· parity Â· nlz Â· ntz Â· divide &amp; conquer in silicon</p>
  <p class="hero-desc fade-up" style="animation-delay:.3s">
    ç¬¬5ç« æ˜¯ Hacker's Delight ä¸­<strong style="color:var(--g)">æœ€å…·ä¼ å¥‡è‰²å½©</strong>çš„ä¸€ç« ã€‚
    "å¦‚ä½•æ•°ä¸€ä¸ªæ•´æ•°é‡Œæœ‰å¤šå°‘ä¸ª1" è¿™ä¸ªé—®é¢˜ï¼Œ
    ä» 1960 å¹´ IBM Stretch çš„ç¡¬ä»¶æŒ‡ä»¤ï¼Œåˆ° HAKMEM å¤‡å¿˜å½•é‡Œçš„é»‘å®¢æ¸¸æˆï¼Œ
    åˆ° x86 çš„ <code style="color:var(--o)">POPCNT</code> æŒ‡ä»¤ï¼Œåˆ° RISC-V çš„ <code style="color:var(--o)">B</code> æ‰©å±•â€”â€”
    è·¨è¶Šå…­åå¹´çš„å·¥ç¨‹å²ï¼Œæ¯ä¸€ä»£ç¨‹åºå‘˜éƒ½åœ¨ç”¨æ›´å°‘çš„æŒ‡ä»¤è§£å†³åŒä¸€ä¸ªé—®é¢˜ã€‚
    è¿™ä¸€ç« è¿˜åŒ…å«å‰å¯¼é›¶ï¼ˆnlz/CLZï¼‰ã€å°¾éšé›¶ï¼ˆntz/CTZï¼‰å’Œå¥‡å¶æ ¡éªŒï¼ˆparityï¼‰â€”â€”
    å››ä¸ªçœ‹ä¼¼ç®€å•å´æ·±è—ç²¾å¦™çš„ä½æ“ä½œåŸè¯­ï¼Œæ˜¯å¯†ç å­¦ã€å‹ç¼©ã€ç½‘ç»œåè®®å’Œ CPU è®¾è®¡çš„å…±åŒåŸºçŸ³ã€‚
  </p>
  <div class="fade-up" style="animation-delay:.4s">
    <span class="tag tag-g">population count</span>
    <span class="tag tag-b">POPCNT / __builtin_popcount</span>
    <span class="tag tag-p">parity / XOR prefix</span>
    <span class="tag tag-o">nlz / CLZ / BSR</span>
    <span class="tag tag-r">ntz / CTZ / BSF</span>
    <span class="tag tag-g">divide &amp; conquer</span>
    <span class="tag tag-b">carry-save adder</span>
    <span class="tag tag-p">de Bruijn sequence</span>
  </div>
</div>

<!-- â•â•â• Â§5-1 POPCOUNT â•â•â• -->
<section id="pop">
  <div class="sec-header">
    <span class="sec-num">Â§5-1</span>
    <span class="sec-title">è®¡æ•°1-ä½ â€” Counting 1-Bits (Population Count)</span>
    <div class="sec-divider"></div>
  </div>

  <div class="insight">
    <span class="label">// THE CLASSIC: åˆ†æ²»æ³•é€æ­¥å½’å¹¶ç›¸é‚»ä½çš„å’Œ</span>
    Warren ä»‹ç»çš„æ ¸å¿ƒæ–¹æ³•æ˜¯<strong>åˆ†æ²»ç­–ç•¥ï¼ˆDivide &amp; Conquerï¼‰</strong>ï¼š
    å…ˆæŠŠ32ä½å­—æ‹†æˆ16ä¸ª2ä½å­—æ®µï¼Œæ¯ä¸ªå­—æ®µå­˜å‚¨å¯¹åº”2ä½ä¸­1çš„ä¸ªæ•°ï¼›
    å†åˆå¹¶ç›¸é‚»2ä½å­—æ®µä¸º4ä½å­—æ®µï¼Œä¾æ­¤ç±»æ¨ï¼Œå…± logâ‚‚(32) = 5 æ­¥å®Œæˆã€‚
    è¿™ä¸æ˜¯ä¸€ä¸ªäººæƒ³å‡ºæ¥çš„æŠ€å·§â€”â€”å®ƒåŒæ—¶å‡ºç°åœ¨ 1960 å¹´ä»£çš„ç¡¬ä»¶ç”µè·¯è®¾è®¡å’Œ HAKMEM memoï¼ˆ1972ï¼‰é‡Œï¼Œ
    æ˜¯å¹¶è¡Œè®¡ç®—æ€ç»´åœ¨å•ä¸ªå¯„å­˜å™¨ä¸Šçš„ç¼©å½±ï¼š<strong>æŠŠä¸²è¡Œé—®é¢˜è½¬åŒ–ä¸ºæ ‘å½¢å¹¶è¡Œå½’å¹¶</strong>ã€‚
  </div>

  <!-- äº¤äº’å¼ popcount æ¼”ç¤º -->
  <div class="card" style="margin-bottom:1.2rem;" x-data="popcountDemo()">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);margin-bottom:.9rem;">
      ğŸ”¬ åˆ†æ²» popcount æ­¥éª¤æ¼”ç¤º â€” è¾“å…¥ä¸€ä¸ª32ä½æ•´æ•°ï¼Œè§‚å¯Ÿæ¯æ­¥å½’å¹¶è¿‡ç¨‹
    </div>
    <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem;">
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:#475569;margin-bottom:.3rem;">åå…­è¿›åˆ¶è¾“å…¥ (0x...)</div>
        <input type="text" x-model="hexInput" @input="parseHex()"
               placeholder="0xDEADBEEF"
               style="width:160px;background:#010409;border:1px solid #1e293b;color:var(--g);font-family:'JetBrains Mono',monospace;font-size:.85rem;padding:.3rem .6rem;border-radius:4px;">
      </div>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:1rem;">
        <button @click="setVal(0xDEADBEEF)" class="tab-btn">0xDEADBEEF</button>
        <button @click="setVal(0xFFFFFFFF)" class="tab-btn">0xFFFFFFFF</button>
        <button @click="setVal(0xAAAAAAAA)" class="tab-btn">0xAAAAAAAA</button>
        <button @click="setVal(0x80000001)" class="tab-btn">0x80000001</button>
        <button @click="setVal(0)" class="tab-btn">0x00000000</button>
      </div>
    </div>

    <!-- åŸå§‹ä½ -->
    <div class="step-row">
      <span class="step-label">åŸå§‹å€¼</span>
      <div class="bit-row" style="margin:0;">
        <template x-for="(b,i) in bits32" :key="i">
          <div class="bit-cell" :class="b?'one':'zero'" x-text="b"></div>
        </template>
      </div>
      <span class="step-eq">= <span style="color:var(--o);" x-text="'0x'+val.toString(16).toUpperCase().padStart(8,'0')"></span></span>
    </div>

    <!-- æ­¥éª¤1: 2ä½å­—æ®µ -->
    <div class="step-row">
      <span class="step-label">æ­¥éª¤1 (2bit)</span>
      <div class="bit-row" style="margin:0;">
        <template x-for="(g,gi) in step1Groups" :key="gi">
          <div style="display:flex;gap:1px;margin-right:3px;">
            <template x-for="(b,bi) in g" :key="bi">
              <div class="bit-cell hi" x-text="b"></div>
            </template>
          </div>
        </template>
      </div>
      <span class="step-eq">æ¯2ä½å­—æ®µ = è¯¥å­—æ®µä¸­1çš„ä¸ªæ•°</span>
    </div>

    <!-- æ­¥éª¤2: 4ä½å­—æ®µ -->
    <div class="step-row">
      <span class="step-label">æ­¥éª¤2 (4bit)</span>
      <div class="bit-row" style="margin:0;">
        <template x-for="(g,gi) in step2Groups" :key="gi">
          <div style="display:flex;gap:1px;margin-right:4px;">
            <template x-for="(b,bi) in g" :key="bi">
              <div class="bit-cell pp" x-text="b"></div>
            </template>
          </div>
        </template>
      </div>
      <span class="step-eq">æ¯4ä½ = 0~4èŒƒå›´å†…çš„å°è®¡</span>
    </div>

    <!-- æ­¥éª¤3: 8ä½å­—æ®µ -->
    <div class="step-row">
      <span class="step-label">æ­¥éª¤3 (8bit)</span>
      <div class="bit-row" style="margin:0;">
        <template x-for="(g,gi) in step3Groups" :key="gi">
          <div style="display:flex;gap:1px;margin-right:6px;">
            <template x-for="(b,bi) in g" :key="bi">
              <div class="bit-cell" :class="bi<6?'zero':'one'" style="border-color:#1e293b;color:#475569;" x-text="b"></div>
            </template>
          </div>
        </template>
      </div>
      <span class="step-eq">æ¯å­—èŠ‚ = 0~8</span>
    </div>

    <!-- æœ€ç»ˆç»“æœ -->
    <div style="display:flex;align-items:center;gap:1rem;margin-top:.8rem;flex-wrap:wrap;">
      <div class="stat-box" style="min-width:120px;">
        <div class="stat-val" x-text="popcount"></div>
        <div class="stat-label">POPULATION COUNT</div>
      </div>
      <div class="stat-box" style="min-width:120px;">
        <div class="stat-val" style="color:var(--b);" x-text="32-popcount"></div>
        <div class="stat-label">ZERO BITS</div>
      </div>
      <div class="stat-box" style="min-width:120px;">
        <div class="stat-val" style="color:var(--p);" x-text="(popcount/32*100).toFixed(1)+'%'"></div>
        <div class="stat-label">å¯†åº¦ (1-bits / 32)</div>
      </div>
      <div class="stat-box" style="min-width:160px;">
        <div class="stat-val" style="color:var(--o);font-size:1rem;" x-text="'0x'+val.toString(16).toUpperCase().padStart(8,'0')"></div>
        <div class="stat-label">HEX VALUE</div>
      </div>
    </div>
  </div>

  <!-- å››ç§å®ç°æ–¹æ³• -->
  <div class="card" style="margin-bottom:1.2rem;">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);margin-bottom:.8rem;">
      ğŸ“š popcount çš„å››ç§ç»å…¸å®ç°â€”â€”ä»æœ´ç´ åˆ°æœ€ä¼˜
    </div>
    <div class="tab-nav" x-data="{t:'warren'}">
      <button class="tab-btn" :class="t==='naive'?'active':''" @click="t='naive'">æœ´ç´ å¾ªç¯</button>
      <button class="tab-btn" :class="t==='warren'?'active':''" @click="t='warren'">Warren åˆ†æ²»</button>
      <button class="tab-btn" :class="t==='hakmem'?'active':''" @click="t='hakmem'">HAKMEM mod63</button>
      <button class="tab-btn" :class="t==='builtin'?'active':''" @click="t='builtin'">ç¡¬ä»¶æŒ‡ä»¤</button>

      <div class="tab-pane" :class="t==='naive'?'active':''">
        <div class="code-block">
<span class="cm">// æ–¹æ³•1: æœ´ç´ å¾ªç¯ â€” O(32) æœ€æ…¢, ä½†æœ€ç›´è§‚</span>
<span class="kw">int</span> <span class="fn">pop_naive</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">int</span> n = <span class="num">0</span>;
  <span class="kw">while</span> (x) {
    n += x &amp; <span class="num">1</span>;    <span class="cm">// æ£€æŸ¥æœ€ä½ä½</span>
    x &gt;&gt;= <span class="num">1</span>;       <span class="cm">// å³ç§»</span>
  }
  <span class="kw">return</span> n;
}
<span class="cm">// æŒ‡ä»¤æ•°: ~64 æ¡ (æœ€åæƒ…å†µ)</span>
<span class="cm">// ç¼ºç‚¹: åˆ†æ”¯ + å¾ªç¯, æ— æ³•æµæ°´çº¿åŒ–</span>

<span class="cm">// å˜ä½“: Kernighan æŠ€å·§ (åªå¾ªç¯1-bitä¸ªæ•°æ¬¡)</span>
<span class="kw">int</span> <span class="fn">pop_kernighan</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">int</span> n = <span class="num">0</span>;
  <span class="kw">while</span> (x) {
    x &amp;= x - <span class="num">1</span>; <span class="cm">// æ¸…é™¤æœ€ä½1ä½</span>
    n++;
  }
  <span class="kw">return</span> n;
}
<span class="cm">// æ¯”æœ´ç´ å¿« (ç¨€ç–1-bitæ—¶), ä½†ä»æœ‰åˆ†æ”¯</span>
<span class="cm">// å†å²: å‡ºè‡ª Kernighan &amp; Ritchieã€ŠCç¨‹åºè®¾è®¡è¯­è¨€ã€‹ç»ƒä¹ </span>
        </div>
      </div>

      <div class="tab-pane" :class="t==='warren'?'active':''">
        <div class="code-block">
<span class="cm">// æ–¹æ³•2: Warren Â§5-1 åˆ†æ²»æ³• â€” 21æ¡æŒ‡ä»¤, æ— åˆ†æ”¯</span>
<span class="cm">// Figure 5-2: æœ€ä¼˜æ— ç¡¬ä»¶æ”¯æŒç‰ˆæœ¬</span>
<span class="kw">int</span> <span class="fn">pop</span>(<span class="kw">unsigned</span> x) {
  <span class="cm">// æ­¥éª¤1: å°†xæ›¿æ¢ä¸º"2ä½å­—æ®µä¸­1çš„ä¸ªæ•°"</span>
  <span class="cm">// x -= (x>>1) & 0x55555555</span>
  <span class="cm">// ç­‰ä»·äº: æ¯å¯¹ [a,b] â†’ [0,a+b] (a,bâˆˆ{0,1})</span>
  x = x - ((x &gt;&gt; <span class="num">1</span>) &amp; <span class="num">0x55555555</span>);

  <span class="cm">// æ­¥éª¤2: åˆå¹¶ç›¸é‚»2ä½å­—æ®µ â†’ 4ä½å­—æ®µ</span>
  x = (x &amp; <span class="num">0x33333333</span>) + ((x &gt;&gt; <span class="num">2</span>) &amp; <span class="num">0x33333333</span>);

  <span class="cm">// æ­¥éª¤3: åˆå¹¶4ä½å­—æ®µ â†’ 8ä½å­—æ®µ, å¹¶æ¶ˆé™¤é«˜ä½</span>
  x = (x + (x &gt;&gt; <span class="num">4</span>)) &amp; <span class="num">0x0F0F0F0F</span>;

  <span class="cm">// æ­¥éª¤4: åˆå¹¶å­—èŠ‚ (å­—èŠ‚å†…æœ€å¤§å€¼8, ä¸ä¼šè¿›ä½åˆ°é«˜å­—èŠ‚)</span>
  x = x + (x &gt;&gt; <span class="num">8</span>);   <span class="cm">// å­—èŠ‚1+å­—èŠ‚0 â†’ é«˜16ä½å­—èŠ‚</span>
  x = x + (x &gt;&gt; <span class="num">16</span>);  <span class="cm">// åˆå¹¶ä¸¤ä¸ª16ä½åŠå­—</span>
  <span class="kw">return</span> x &amp; <span class="num">0x0000003F</span>; <span class="cm">// åªå–ä½6ä½ (0~32)</span>
}

<span class="cm">// é­”æ³•å¸¸æ•°çš„å«ä¹‰:</span>
<span class="cm">// 0x55555555 = 0101 0101 ... 0101 (é€‰å¥‡æ•°ä½)</span>
<span class="cm">// 0x33333333 = 0011 0011 ... 0011 (é€‰æ¯4ä½ä¸­ä½2ä½)</span>
<span class="cm">// 0x0F0F0F0F = 0000 1111 ... 1111 (é€‰æ¯å­—èŠ‚ä½4ä½)</span>
<span class="cm">// 0x0000003F = 0...0 0011 1111   (æœ€ç»ˆæ©ç )</span>

<span class="cm">// æ­¥éª¤1çš„å¦™å¤„: x - ((x>>1) & 0x55555555)</span>
<span class="cm">// åŸå§‹ç : ab (a,b âˆˆ {0,1})</span>
<span class="cm">// (x>>1) & 0x55: å–a (é«˜ä½)åˆ°ä½ä½</span>
<span class="cm">// x - (x>>1)&0x55 = 2a+b - a = a+b âœ“</span>
<span class="cm">// æ¯” (x&0x55) + ((x>>1)&0x55) å°‘ä¸€æ¡æŒ‡ä»¤</span>
        </div>
      </div>

      <div class="tab-pane" :class="t==='hakmem'?'active':''">
        <div class="code-block">
<span class="cm">// æ–¹æ³•3: HAKMEM memo (1972) item 169 â€” mod 63 ç®—æ³•</span>
<span class="cm">// å‡ºè‡ª MIT AI Lab, Gosper/Beeler/Schroeppel</span>
<span class="kw">int</span> <span class="fn">pop_hakmem</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">unsigned</span> n;
  n = (x &gt;&gt; <span class="num">1</span>) &amp; <span class="num">033333333333</span>;  <span class="cm">// å…«è¿›åˆ¶! 0x1B6DB6DB</span>
  x = x - n;
  n = (n &gt;&gt; <span class="num">1</span>) &amp; <span class="num">033333333333</span>;
  x = x - n;
  <span class="cm">// ç°åœ¨xæ˜¯ 3-bit å­—æ®µçš„bitcountä¹‹å’Œ</span>
  x = (x + (x &gt;&gt; <span class="num">3</span>)) &amp; <span class="num">030707070707</span>; <span class="cm">// 6-bitå­—æ®µ</span>
  <span class="kw">return</span> x % <span class="num">63</span>;   <span class="cm">// 6ä½å­—æ®µä¹‹å’Œ â‰¡ æ€»å’Œ (mod 63)</span>
}
<span class="cm">// åŸç†: 6-bitæœ€å¤§å€¼63 = 2^6-1 = 0x3F</span>
<span class="cm">// ä¸€ä¸ª32ä½æ•´æ•° = 5ä¸ª6ä½å­—æ®µ + 2ä½ä½™é‡</span>
<span class="cm">// å„6ä½å­—æ®µä¹‹å’Œ mod 63 = å…¨éƒ¨ä¹‹å’Œ</span>
<span class="cm">// å› ä¸º 64 â‰¡ 1 (mod 63) â†’ ä½æƒåœ¨mod63ä¸‹ç­‰ä»·</span>
<span class="cm">// ç¼ºç‚¹: æ¨¡è¿ç®—åœ¨æ— ç¡¬ä»¶é™¤æ³•çš„æœºå™¨ä¸Šæ˜‚è´µ</span>
<span class="cm">// ä¼˜ç‚¹: åœ¨æœ‰å¿«é€Ÿmodçš„æœºå™¨ä¸Šä»£ç æçŸ­</span>

<span class="cm">// 64-bit ç‰ˆ: ä½¿ç”¨ mod 255</span>
<span class="cm">// ç±»ä¼¼åœ°: 256 â‰¡ 1 (mod 255)</span>
<span class="cm">// 8ä¸ª8-bitå­—æ®µä¹‹å’Œ mod 255 = æ€»1-bitæ•°</span>
<span class="kw">int</span> <span class="fn">pop64_mod255</span>(<span class="kw">unsigned long long</span> x) {
  x -= (x &gt;&gt; <span class="num">1</span>) &amp; <span class="num">0x5555555555555555ULL</span>;
  x = (x &amp; <span class="num">0x3333333333333333ULL</span>) +
      ((x &gt;&gt; <span class="num">2</span>) &amp; <span class="num">0x3333333333333333ULL</span>);
  x = (x + (x &gt;&gt; <span class="num">4</span>)) &amp; <span class="num">0x0F0F0F0F0F0F0F0FULL</span>;
  <span class="kw">return</span> (x * <span class="num">0x0101010101010101ULL</span>) &gt;&gt; <span class="num">56</span>;
  <span class="cm">// ä¹˜ä»¥å…¨1å­—èŠ‚å‘é‡ â†’ å°†8ä¸ªå­—èŠ‚ç´¯åŠ åˆ°æœ€é«˜å­—èŠ‚</span>
}
        </div>
      </div>

      <div class="tab-pane" :class="t==='builtin'?'active':''">
        <div class="code-block">
<span class="cm">// æ–¹æ³•4: ç¡¬ä»¶æŒ‡ä»¤ â€” æœ€å¿«, 1-3 å‘¨æœŸ</span>

<span class="cm">// C/C++: GCC/Clang å†…å»º</span>
<span class="kw">int</span> <span class="fn">pop_hw</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">return</span> __builtin_popcount(x);
  <span class="cm">// GCC ä¼šæ ¹æ®ç›®æ ‡æ¶æ„é€‰æ‹©:</span>
  <span class="cm">// x86 with SSE4.2: POPCNT eax, edi  (1æŒ‡ä»¤)</span>
  <span class="cm">// ARM v8-A:        CNT + ADDV       (2æŒ‡ä»¤)</span>
  <span class="cm">// RISC-V B-ext:    CPOP rd, rs1     (1æŒ‡ä»¤)</span>
}

<span class="cm">// x86 POPCNT (Intel Nehalem 2008 èµ·):</span>
<span class="cm">// POPCNT r64, r/m64 â€” 1 cycle latency, 1 cycle throughput</span>
<span class="cm">// ç¼–è¯‘: gcc -mpopcnt -O2</span>
<span class="cm">// æ³¨æ„: æœ‰"è™šå‡ä¾èµ–"bug (Haswellå‰), ç›®æ ‡å¯„å­˜å™¨éœ€æ¸…é›¶</span>

<span class="cm">// ARM64 (AArch64):</span>
<span class="cm">// CNT v0.8b, v0.8b   â€” å­—èŠ‚çº§popcount (SIMD)</span>
<span class="cm">// ADDV b0, v0.8b     â€” æ°´å¹³åŠ æ³•å½’å¹¶å­—èŠ‚</span>
<span class="cm">// æ€»è®¡2æ¡SIMDæŒ‡ä»¤, å¯æ‰¹é‡å¤„ç†</span>

<span class="cm">// Java:</span>
<span class="cm">// Integer.bitCount(x)  // JITè‡ªåŠ¨æ˜ å°„åˆ°POPCNT</span>
<span class="cm">// Long.bitCount(x)     // 64ä½ç‰ˆæœ¬</span>

<span class="cm">// Rust:</span>
<span class="cm">// x.count_ones()       // æ ‡å‡†åº“, è‡ªåŠ¨POPCNT</span>

<span class="cm">// Python:</span>
<span class="cm">// bin(x).count('1')   // æœ´ç´ , ä½†CPythonä¼˜åŒ–äº†å­—ç¬¦ä¸²</span>
<span class="cm">// int.bit_count()     // Python 3.10+ åŸç”Ÿæ–¹æ³•</span>

<span class="cm">// æ€§èƒ½å¯¹æ¯” (Skylake, 32-bit):</span>
<span class="cm">// POPCNT:        ~1 cycle</span>
<span class="cm">// Warren Â§5-1:   ~8 cycles (21 instructions)</span>
<span class="cm">// HAKMEM:        ~12 cycles (å«mod)</span>
<span class="cm">// æœ´ç´ å¾ªç¯:       ~50 cycles (å¹³å‡16ä¸ª1)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- CSA æ–¹æ³• -->
  <div class="card" style="margin-bottom:1.2rem;">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--b);margin-bottom:.75rem;">
      âš¡ è¿›é˜¶ï¼šè¿›ä½ä¿å­˜åŠ æ³•å™¨ï¼ˆCSAï¼‰æ‰¹é‡ popcount â€” å¤§æ•°ç»„çš„æœ€ä¼˜è§£
    </div>
    <div class="insight" style="margin-bottom:.75rem;">
      <span class="label">// CARRY-SAVE ADDER â€” ç¡¬ä»¶ç”µè·¯æ€ç»´è¿ç§»åˆ°è½¯ä»¶</span>
      å½“éœ€è¦å¯¹ä¸€ä¸ªå¤§æ•°ç»„æ±‚æ€» popcount æ—¶ï¼ŒWarren Â§5-1 ç»™å‡ºäº†åŸºäº
      <strong>è¿›ä½ä¿å­˜åŠ æ³•å™¨ï¼ˆCSA, 3:2 å‹ç¼©å™¨ï¼‰</strong>çš„æ–¹æ¡ˆã€‚
      CSA å°†ä¸‰ä¸ªè¾“å…¥å‹ç¼©ä¸ºä¸¤ä¸ªï¼ˆsum + carryï¼‰ï¼Œåœ¨è½¯ä»¶ä¸­ç”¨ 5 æ¡é€»è¾‘æŒ‡ä»¤æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´åŠ æ³•å™¨ã€‚
      æ¯æ¬¡è¿­ä»£å¤„ç†8ä¸ªæ•°ç»„å…ƒç´ ï¼Œç›¸æ¯”æœ´ç´ æ–¹æ³•ï¼ˆæ¯ä¸ªå…ƒç´ å•ç‹¬è°ƒç”¨ pop()ï¼‰å‡å°‘äº†çº¦ 40% çš„æŒ‡ä»¤æ•°ã€‚
      è¿™ä¸ªæ–¹æ³•çš„èµ·æºæ˜¯ç¡¬ä»¶ä¹˜æ³•å™¨ç”µè·¯â€”â€”Harley å’Œ Seal åœ¨1996-97å¹´å°†å…¶è¿ç§»åˆ°è½¯ä»¶ popcountã€‚
    </div>
    <div class="code-block">
<span class="cm">// Â§5-1 CSA (3:2 å‹ç¼©å™¨) å®:</span>
<span class="cm">// å°†ä¸‰ä¸ª32ä½å­— a,b,c å‹ç¼©ä¸º (h=è¿›ä½, l=å’Œ)</span>
<span class="cm">// å…¨åŠ å™¨é€»è¾‘ (æ¯ä½ç‹¬ç«‹å¹¶è¡Œ):</span>
<span class="cm">//   h = (a&b) | (a&c) | (b&c)  = ab|(a^b)c</span>
<span class="cm">//   l = a ^ b ^ c</span>
<span class="cm">// CSA ç”¨5æ¡é€»è¾‘æŒ‡ä»¤åœ¨32ä¸ªç‹¬ç«‹1-bitå…¨åŠ å™¨ä¸Šå¹¶è¡Œè¿è¡Œ</span>

<span class="cm">// å¯¹å¤§æ•°ç»„ A[n] æ±‚æ€»popcount, 8å…ƒç´ ä¸€ç»„:</span>
<span class="kw">long long</span> <span class="fn">array_pop8</span>(<span class="kw">unsigned</span> *A, <span class="kw">int</span> n) {
  <span class="kw">long long</span> total = <span class="num">0</span>;
  <span class="kw">unsigned</span> ones = <span class="num">0</span>, twos = <span class="num">0</span>, fours = <span class="num">0</span>, eights = <span class="num">0</span>;
  <span class="kw">int</span> i;
  <span class="kw">for</span> (i = <span class="num">0</span>; i &lt;= n - <span class="num">8</span>; i += <span class="num">8</span>) {
    <span class="kw">unsigned</span> t1, t2, t3, t4;
    <span class="cm">// CSA1: ones, A[i], A[i+1] â†’ twos_ab, ones</span>
    t1 = ones ^ A[i]; t2 = A[i+<span class="num">1</span>];
    <span class="kw">unsigned</span> twos_ab = (ones &amp; A[i]) | ((t1) &amp; t2);
    ones = t1 ^ t2;
    <span class="cm">// CSA2: twos_ab, A[i+2], A[i+3] â†’ fours_ab, twos_cd</span>
    t1 = twos_ab ^ A[i+<span class="num">2</span>]; t3 = A[i+<span class="num">3</span>];
    <span class="kw">unsigned</span> fours_ab = (twos_ab &amp; A[i+<span class="num">2</span>]) | (t1 &amp; t3);
    <span class="kw">unsigned</span> twos_cd  = t1 ^ t3;
    <span class="cm">// ...åç»­ CSA3-7 ç±»ä¼¼ (å¤„ç† A[i+4..7])</span>
    <span class="cm">// æœ€ç»ˆ: total += 8*pop(eights)+4*pop(fours)+2*pop(twos)+pop(ones)</span>
    total += <span class="fn">pop</span>(fours_ab);  <span class="cm">// ç®€åŒ–ç¤ºæ„</span>
  }
  <span class="cm">// å¤„ç†å‰©ä½™å…ƒç´ </span>
  <span class="kw">for</span> (; i &lt; n; i++) total += <span class="fn">pop</span>(A[i]);
  <span class="kw">return</span> total + <span class="fn">pop</span>(ones) + <span class="num">2</span>*<span class="fn">pop</span>(twos) + <span class="num">4</span>*<span class="fn">pop</span>(fours);
}
<span class="cm">// æ€§èƒ½: ~12.33 æŒ‡ä»¤/å­— vs æœ´ç´  ~16 æŒ‡ä»¤/å­—</span>
<span class="cm">// ç°ä»£: AVX-512 VPOPCNTDQ æ¯å‘¨æœŸå¤„ç† 16Ã—32bit = 512bit!</span>
    </div>
  </div>

  <!-- æ€§èƒ½å›¾ -->
  <div class="card">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--o);margin-bottom:.5rem;">
      ğŸ“Š å„ç§ popcount å®ç°çš„æŒ‡ä»¤æ•°å¯¹æ¯”ï¼ˆ32ä½æ•´æ•°ï¼‰
    </div>
    <div id="chart-pop" style="width:100%;height:240px;"></div>
  </div>
</section>

<!-- â•â•â• Â§5-2 å¥‡å¶æ ¡éªŒ â•â•â• -->
<section id="parity">
  <div class="sec-header">
    <span class="sec-num">Â§5-2</span>
    <span class="sec-title">å¥‡å¶æ ¡éªŒ â€” Parity</span>
    <div class="sec-divider"></div>
  </div>

  <div class="insight">
    <span class="label">// PARITY = popcount(x) & 1 = XOR of all bits</span>
    å¥‡å¶æ ¡éªŒï¼ˆparityï¼‰å°±æ˜¯"1-bitçš„ä¸ªæ•°æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°"ï¼Œç­‰ä»·äº<strong>æ‰€æœ‰ä½çš„ XOR</strong>ã€‚
    è¿™ä¸ªç­‰ä»·æ€§æ˜¯å¹¶è¡Œå‰ç¼€ï¼ˆParallel Prefixï¼‰è®¡ç®—çš„å®Œç¾ä¾‹å­ï¼š
    XOR æ˜¯ç»“åˆå¾‹è¿ç®—ï¼Œ32ä½çš„ XOR å½’çº¦å¯ä»¥ç”¨ 5 æ­¥å®Œæˆï¼ˆæ¯æ­¥æŠ˜å ä¸€åŠï¼‰ã€‚
    Warren æŒ‡å‡ºè¿™ä¸ Gray ç çš„æ€§è´¨æ·±åº¦å…³è”ï¼š
    <code style="color:var(--o)">Gray(x) çš„ç¬¬ i ä½ = parity(x â‰« i)</code>ï¼Œ
    æ ¼é›·ç è½¬äºŒè¿›åˆ¶çš„é€†è¿ç®—æœ¬è´¨ä¸Šå°±æ˜¯å‰ç¼€ XORã€‚
  </div>

  <div class="grid-2" style="margin-bottom:1.2rem;">
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);margin-bottom:.7rem;">å¥‡å¶æ ¡éªŒå®ç°ï¼ˆå¹¶è¡Œå‰ç¼€ XORï¼‰</div>
      <div class="code-block">
<span class="cm">// Â§5-2 å¥‡å¶æ ¡éªŒ: è¿”å› popcount(x) % 2</span>
<span class="cm">// æ–¹æ³•1: ç›´æ¥è°ƒç”¨ popcount</span>
<span class="kw">int</span> <span class="fn">parity_pop</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">return</span> <span class="fn">pop</span>(x) &amp; <span class="num">1</span>;
}

<span class="cm">// æ–¹æ³•2: å¹¶è¡Œå‰ç¼€ XOR (Warren Â§5-2, 5æ­¥)</span>
<span class="kw">int</span> <span class="fn">parity</span>(<span class="kw">unsigned</span> x) {
  x ^= x &gt;&gt; <span class="num">16</span>;  <span class="cm">// æŠ˜å é«˜16ä½åˆ°ä½16ä½</span>
  x ^= x &gt;&gt; <span class="num">8</span>;   <span class="cm">// æŠ˜å é«˜8ä½åˆ°ä½8ä½</span>
  x ^= x &gt;&gt; <span class="num">4</span>;   <span class="cm">// æŠ˜å é«˜4ä½åˆ°ä½4ä½</span>
  x ^= x &gt;&gt; <span class="num">2</span>;
  x ^= x &gt;&gt; <span class="num">1</span>;
  <span class="kw">return</span> x &amp; <span class="num">1</span>;   <span class="cm">// å–æœ€ä½ä½</span>
}
<span class="cm">// å…± 5Ã—2 = 10 æ¡æŒ‡ä»¤, æ— åˆ†æ”¯, å¯æµæ°´çº¿</span>

<span class="cm">// æ–¹æ³•3: æŸ¥è¡¨ (é€‚åˆ8-bitå—)</span>
<span class="cm">// é¢„è®¡ç®— parity_table[256]</span>
<span class="kw">int</span> <span class="fn">parity_table</span>(<span class="kw">unsigned</span> x) {
  x ^= x &gt;&gt; <span class="num">16</span>;
  x ^= x &gt;&gt; <span class="num">8</span>;
  <span class="kw">return</span> parity_table[x &amp; <span class="num">0xFF</span>];
  <span class="cm">// åªéœ€2æ¬¡æŠ˜å +1æ¬¡æŸ¥è¡¨</span>
}

<span class="cm">// æ–¹æ³•4: ç¡¬ä»¶</span>
<span class="cm">// x86: POPCNT + AND 1 (æ— ç›´æ¥parityæŒ‡ä»¤)</span>
<span class="cm">// x86 EFLAGS: PF (Parity Flag) ç»™å‡ºæœ€ä½å­—èŠ‚å¥‡å¶æ€§</span>
<span class="cm">// éœ€è¦æŠ˜å åå†ç”¨ LAHF/SETPE å–PFä½</span>
<span class="cm">// GCC: __builtin_parity(x) â€” æœ€ä¼˜é€‰æ‹©</span>
      </div>
    </div>
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--b);margin-bottom:.7rem;">å¹¶è¡Œå‰ç¼€ XOR çš„å¯è§†åŒ–è¿‡ç¨‹</div>
      <!-- å¥‡å¶æ ¡éªŒæ¼”ç¤º -->
      <div x-data="parityDemo()">
        <div style="display:flex;gap:.75rem;align-items:center;margin-bottom:.75rem;flex-wrap:wrap;">
          <div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:#475569;margin-bottom:.25rem;">è¾“å…¥å€¼</div>
            <input type="text" x-model="hexIn" @input="parse()"
                   style="width:120px;background:#010409;border:1px solid #1e293b;color:var(--b);font-family:'JetBrains Mono',monospace;font-size:.8rem;padding:.28rem .5rem;border-radius:3px;"
                   placeholder="0xDEADBEEF">
          </div>
          <div class="stat-box" style="min-width:80px;">
            <div class="stat-val" style="color:var(--p);" x-text="parity?'å¥‡':'å¶'"></div>
            <div class="stat-label">PARITY</div>
          </div>
        </div>
        <!-- æ­¥éª¤å±•ç¤º -->
        <div style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:#334155;margin-bottom:.4rem;">å¹¶è¡Œå‰ç¼€ XOR æŠ˜å è¿‡ç¨‹ï¼š</div>
        <template x-for="(step,si) in steps" :key="si">
          <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem;flex-wrap:wrap;">
            <span style="font-family:'JetBrains Mono',monospace;font-size:.6rem;color:#475569;width:100px;" x-text="step.label"></span>
            <div class="bit-row" style="margin:0;gap:1px;">
              <template x-for="(b,bi) in step.bits" :key="bi">
                <div class="bit-cell" :class="b?'one':'zero'" style="width:16px;height:16px;font-size:.55rem;" x-text="b"></div>
              </template>
            </div>
            <span style="font-family:'JetBrains Mono',monospace;font-size:.6rem;color:#334155;" x-text="'= 0x'+step.val.toString(16).toUpperCase().padStart(8,'0')"></span>
          </div>
        </template>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--g);margin-top:.5rem;" x-text="'æœ€ç»ˆ bit[0] = '+(val32&1)+' â†’ parity = '+(parity?'å¥‡æ•°ä¸ª1':'å¶æ•°ä¸ª1')"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--p);margin-bottom:.75rem;">ğŸ“¦ å¥‡å¶æ ¡éªŒçš„å®é™…åº”ç”¨åœºæ™¯</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:.65rem;">
      <div style="padding:.65rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--g);margin-bottom:.3rem;">ğŸ’¾ ECC å†…å­˜</div>
        <div style="font-size:.78rem;color:#64748b;line-height:1.65;">DDR å†…å­˜çš„ ECCï¼ˆError-Correcting Codeï¼‰ä½¿ç”¨<strong style="color:#94a3b8">æ±‰æ˜ç </strong>ï¼Œå…¶æ ¸å¿ƒæ˜¯å¯¹æ•°æ®ä½çš„å¤šç»„å¥‡å¶æ ¡éªŒã€‚æ¯64å­—èŠ‚æ•°æ®é™„åŠ 8å­—èŠ‚ ECCï¼Œèƒ½æ£€æµ‹2ä½é”™è¯¯å¹¶çº æ­£1ä½é”™è¯¯ã€‚æœåŠ¡å™¨å†…å­˜æ¯æ¬¡å†™æ“ä½œéƒ½è¦è®¡ç®—è¿™äº›æ ¡éªŒä½ã€‚</div>
      </div>
      <div style="padding:.65rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--b);margin-bottom:.3rem;">ğŸ“¡ ä¸²è¡Œé€šä¿¡ (UART/RS-232)</div>
        <div style="font-size:.78rem;color:#64748b;line-height:1.65;">UART åè®®å¯é€‰å¥‡å¶æ ¡éªŒä½ï¼ˆEven/Odd/Noneï¼‰ï¼Œæ¯å¸§æ•°æ®åœ¨åœæ­¢ä½å‰é™„åŠ 1ä½å¥‡å¶æ ¡éªŒã€‚ç¡¬ä»¶ UART æ§åˆ¶å™¨ç”¨ XOR æ ‘å®ç°ï¼Œå®Œå…¨å¹¶è¡Œè®¡ç®—ï¼Œä¸å½±å“æ³¢ç‰¹ç‡ã€‚</div>
      </div>
      <div style="padding:.65rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--o);margin-bottom:.3rem;">ğŸ” å¯†ç å­¦ (GF(2) è¿ç®—)</div>
        <div style="font-size:.78rem;color:#64748b;line-height:1.65;">GF(2) ä¸Šçš„å¤šé¡¹å¼è¿ç®—æœ¬è´¨æ˜¯ XORã€‚AES çš„ GF(2â¸) ä¹˜æ³•ã€CRC æ ¡éªŒã€LDPC çº é”™ç éƒ½å¤§é‡ä½¿ç”¨å¥‡å¶æ ¡éªŒçš„å˜ä½“ã€‚ç°ä»£ CPU ä¸“ä¸ºæ­¤æä¾› <code style="color:var(--o)">PCLMULQDQ</code> æŒ‡ä»¤ï¼ˆè¿›ä½lessä¹˜æ³• = XOR å¤šé¡¹å¼ä¹˜ï¼‰ã€‚</div>
      </div>
      <div style="padding:.65rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--p);margin-bottom:.3rem;">ğŸ§¬ Gray ç è½¬æ¢</div>
        <div style="font-size:.78rem;color:#64748b;line-height:1.65;">Gray ç è½¬äºŒè¿›åˆ¶ = å¹¶è¡Œå‰ç¼€ XORï¼ˆÂ§13-1ï¼‰ã€‚Warren æŒ‡å‡ºè¿™ä¸å¥‡å¶æ ¡éªŒçš„è®¡ç®—ç»“æ„å®Œå…¨ç›¸åŒï¼Œåªæ˜¯æŠŠ"æŠ˜å åå–æœ€ä½ä½"æ¢æˆäº†"ä¿ç•™æ¯æ­¥çš„ç»“æœ"ã€‚å‰ç¼€ XOR æ˜¯å¯é€†çš„ï¼Œé€†è¿ç®—ä»æ˜¯å‰ç¼€ XORã€‚</div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• Â§5-3 å‰å¯¼é›¶ nlz â•â•â• -->
<section id="nlz">
  <div class="sec-header">
    <span class="sec-num">Â§5-3</span>
    <span class="sec-title">å‰å¯¼é›¶è®¡æ•° â€” Counting Leading Zeros (nlz / CLZ)</span>
    <div class="sec-divider"></div>
  </div>

  <div class="insight">
    <span class="label">// nlz(x) = æœ€é«˜1ä½ä¹‹å‰æœ‰å¤šå°‘ä¸ª0</span>
    <code style="color:var(--o)">nlz(x)</code>ï¼ˆnumber of leading zerosï¼‰å‘Šè¯‰ä½ æœ€é«˜æœ‰æ•ˆä½åœ¨å“ªé‡Œï¼Œ
    ç­‰ä»·äº <code style="color:var(--o)">31 - floor(logâ‚‚(x))</code>ï¼ˆx&gt;0æ—¶ï¼‰ã€‚
    è¿™ä¸ªå‡½æ•°åœ¨æ•´æ•°å¯¹æ•°è®¡ç®—ã€è§„èŒƒåŒ–ã€IEEEæµ®ç‚¹æŒ‡æ•°æå–ã€å“ˆå¸Œè¡¨å¤§å°èˆå…¥ç­‰åœºæ™¯æ— å¤„ä¸åœ¨ã€‚
    Warren ç»™å‡ºäº†ä¸‰æ¡è·¯å¾„ï¼š<strong>äºŒåˆ†æœç´¢æ³•</strong>ï¼ˆ5æ­¥ï¼Œ21æ¡æŒ‡ä»¤ï¼‰ã€
    <strong>æµ®ç‚¹æŒ‡æ•°å€Ÿç”¨æ³•</strong>ï¼ˆæŠŠæ•´æ•°è½¬ä¸º doubleï¼Œæå–æŒ‡æ•°å­—æ®µï¼‰ã€
    ä»¥åŠ<strong>De Bruijn ä¹˜æ³•æŸ¥è¡¨æ³•</strong>ã€‚æ¯ç§æ–¹æ³•éƒ½ä»£è¡¨ä¸€ç§å®Œå…¨ä¸åŒçš„è®¡ç®—å“²å­¦ã€‚
  </div>

  <!-- äº¤äº’æ¼”ç¤º -->
  <div class="card" style="margin-bottom:1.2rem;" x-data="nlzDemo()">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);margin-bottom:.9rem;">
      ğŸ”¬ nlz æ¼”ç¤º â€” æ‹–åŠ¨æ»‘å—æˆ–è¾“å…¥å€¼ï¼Œè§‚å¯Ÿæœ€é«˜1ä½ä½ç½®
    </div>
    <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-bottom:.75rem;">
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:#475569;margin-bottom:.25rem;">åå…­è¿›åˆ¶</div>
        <input type="text" x-model="hexIn" @input="parseH()"
               style="width:120px;background:#010409;border:1px solid #1e293b;color:var(--g);font-family:'JetBrains Mono',monospace;font-size:.8rem;padding:.28rem .5rem;border-radius:3px;">
      </div>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-top:1rem;">
        <button @click="setV(1)"        class="tab-
btn">1</button>
        <button @click="setV(0x00000080)" class="tab-btn">0x80</button>
        <button @click="setV(0x00008000)" class="tab-btn">0x8000</button>
        <button @click="setV(0x80000000)" class="tab-btn">0x80000000</button>
        <button @click="setV(0xDEADBEEF)" class="tab-btn">0xDEAD</button>
      </div>
    </div>

    <!-- ä½å›¾æ˜¾ç¤º -->
    <div class="bit-row" style="margin-bottom:.6rem;">
      <template x-for="(b,i) in bits" :key="i">
        <div class="bit-cell"
             :class="i < nlz ? 'zero' : (i === nlz ? 'warn' : 'one')"
             x-text="b"
             :title="'bit '+(31-i)"></div>
      </template>
    </div>
    <div style="display:flex;gap:.3rem;flex-wrap:wrap;margin-bottom:.6rem;">
      <template x-for="(b,i) in bits" :key="i">
        <div style="width:22px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:.48rem;"
             :style="{color: i===nlz?'var(--r)':'#1e293b'}"
             x-text="31-i"></div>
      </template>
    </div>

    <div style="display:flex;gap:.65rem;flex-wrap:wrap;">
      <div class="stat-box" style="min-width:110px;">
        <div class="stat-val" x-text="nlz"></div>
        <div class="stat-label">nlz (å‰å¯¼é›¶)</div>
      </div>
      <div class="stat-box" style="min-width:110px;">
        <div class="stat-val" style="color:var(--b);" x-text="val32===0?'â€”':msb"></div>
        <div class="stat-label">æœ€é«˜1ä½ä½ç½®</div>
      </div>
      <div class="stat-box" style="min-width:110px;">
        <div class="stat-val" style="color:var(--p);" x-text="val32===0?'â€”':Math.floor(Math.log2(val32)).toFixed(0)"></div>
        <div class="stat-label">floor(logâ‚‚ x)</div>
      </div>
      <div class="stat-box" style="min-width:140px;">
        <div class="stat-val" style="color:var(--o);font-size:1rem;" x-text="'0x'+val32.toString(16).toUpperCase().padStart(8,'0')"></div>
        <div class="stat-label">HEX</div>
      </div>
    </div>
  </div>

  <!-- nlz å››ç§å®ç° -->
  <div class="grid-2" style="margin-bottom:1.2rem;">
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);margin-bottom:.7rem;">
        nlz å®ç°æ–¹æ³•å¯¹æ¯”
      </div>
      <div class="tab-nav" x-data="{t:'bisect'}">
        <button class="tab-btn" :class="t==='bisect'?'active':''" @click="t='bisect'">äºŒåˆ†æœç´¢</button>
        <button class="tab-btn" :class="t==='fp'?'active':''" @click="t='fp'">æµ®ç‚¹å€Ÿç”¨</button>
        <button class="tab-btn" :class="t==='debruijn'?'active':''" @click="t='debruijn'">De Bruijn</button>
        <button class="tab-btn" :class="t==='hw'?'active':''" @click="t='hw'">ç¡¬ä»¶æŒ‡ä»¤</button>

        <div class="tab-pane" :class="t==='bisect'?'active':''">
          <div class="code-block">
<span class="cm">// Â§5-3 äºŒåˆ†æœç´¢æ³• nlz â€” Warren Figure 5-12</span>
<span class="cm">// 5æ­¥ç¡®å®šæœ€é«˜1ä½, å…±21æ¡æŒ‡ä»¤, æ— åˆ†æ”¯</span>
<span class="kw">int</span> <span class="fn">nlz</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">int</span> n;
  <span class="kw">if</span> (x == <span class="num">0</span>) <span class="kw">return</span> <span class="num">32</span>;
  n = <span class="num">0</span>;
  <span class="cm">// æ¯æ­¥ç¼©å°æœç´¢èŒƒå›´ä¸€åŠ</span>
  <span class="kw">if</span> (x &lt;= <span class="num">0x0000FFFF</span>) { n += <span class="num">16</span>; x &lt;&lt;= <span class="num">16</span>; }
  <span class="kw">if</span> (x &lt;= <span class="num">0x00FFFFFF</span>) { n +=  <span class="num">8</span>; x &lt;&lt;=  <span class="num">8</span>; }
  <span class="kw">if</span> (x &lt;= <span class="num">0x0FFFFFFF</span>) { n +=  <span class="num">4</span>; x &lt;&lt;=  <span class="num">4</span>; }
  <span class="kw">if</span> (x &lt;= <span class="num">0x3FFFFFFF</span>) { n +=  <span class="num">2</span>; x &lt;&lt;=  <span class="num">2</span>; }
  <span class="kw">if</span> (x &lt;= <span class="num">0x7FFFFFFF</span>) { n +=  <span class="num">1</span>;         }
  <span class="kw">return</span> n;
}
<span class="cm">// åˆ†æ”¯ç‰ˆæœ¬: æœ€å5æ¬¡åˆ†æ”¯</span>
<span class="cm">// æ— åˆ†æ”¯ç‰ˆæœ¬ (ç”¨æ©ç ä»£æ›¿if):</span>
<span class="kw">int</span> <span class="fn">nlz_branchless</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">int</span> n = <span class="num">32</span>;
  <span class="kw">unsigned</span> y;
  y = x &gt;&gt;<span class="num">16</span>; <span class="kw">if</span>(y) { n-=<span class="num">16</span>; x=y; }
  y = x &gt;&gt; <span class="num">8</span>; <span class="kw">if</span>(y) { n-= <span class="num">8</span>; x=y; }
  y = x &gt;&gt; <span class="num">4</span>; <span class="kw">if</span>(y) { n-= <span class="num">4</span>; x=y; }
  y = x &gt;&gt; <span class="num">2</span>; <span class="kw">if</span>(y) { n-= <span class="num">2</span>; x=y; }
  y = x &gt;&gt; <span class="num">1</span>; <span class="kw">if</span>(y) { n-= <span class="num">1</span>; x=y; }
  <span class="kw">return</span> n - x;
}
          </div>
        </div>

        <div class="tab-pane" :class="t==='fp'?'active':''">
          <div class="code-block">
<span class="cm">// Â§5-3 æµ®ç‚¹æŒ‡æ•°å€Ÿç”¨æ³• â€” Warren Figure 5-19</span>
<span class="cm">// æŠŠæ•´æ•°è½¬ä¸º IEEE 754 double, æå–æŒ‡æ•°å­—æ®µ</span>
<span class="cm">// IEEE double: [ç¬¦å·1ä½][æŒ‡æ•°11ä½][å°¾æ•°52ä½]</span>
<span class="cm">// å¦‚æœ x > 0: double(x) çš„æŒ‡æ•° = 1023 + floor(log2 x)</span>
<span class="cm">// å› æ­¤: nlz(x) = 31 - floor(log2 x) = 1054 - exponent</span>

<span class="cm">// æ³¨æ„: ä»¥ä¸‹ä»£ç ä¾èµ– type-punning, ä¸¥æ ¼è¯´æ˜¯ UB</span>
<span class="cm">// C++20 å¯ç”¨ std::bit_cast æ›¿ä»£</span>
<span class="kw">int</span> <span class="fn">nlz_float</span>(<span class="kw">unsigned</span> k) {
  <span class="kw">union</span> {
    <span class="kw">unsigned</span> asInt[<span class="num">2</span>];
    <span class="kw">double</span>   asDouble;
  };
  <span class="kw">int</span> n;
  asDouble = (<span class="kw">double</span>)k + <span class="num">0.5</span>;  <span class="cm">// +0.5 å¤„ç†k=0</span>
  <span class="cm">// LE=1(å°ç«¯): æŒ‡æ•°åœ¨ asInt[1] çš„é«˜11ä½</span>
  n = <span class="num">1054</span> - (asInt[<span class="num">1</span>] &gt;&gt; <span class="num">20</span>);
  <span class="kw">return</span> n;
}
<span class="cm">// åŸç†: 1023 + floor(log2 k) = æŒ‡æ•°å­—æ®µ</span>
<span class="cm">// 1054 - æŒ‡æ•° = 31 - floor(log2 k) = nlz(k) âœ“</span>

<span class="cm">// 32ä½floatç‰ˆ (æŒ‡æ•°8ä½, åç§»127):</span>
<span class="cm">// asFloat = (float)k + 0.5f</span>
<span class="cm">// n = 158 - (asInt >> 23)  // 158 = 127+31</span>

<span class="cm">// ç¼ºç‚¹: æ•´æ•°â†’æµ®ç‚¹è½¬æ¢æ…¢(5-10å‘¨æœŸ)</span>
<span class="cm">// è·¨å¯„å­˜å™¨ç»„çš„æ•°æ®ç§»åŠ¨ä»£ä»·é«˜</span>
<span class="cm">// ç°ä»£ CPU ç”¨ LZCNT åªéœ€ 1 å‘¨æœŸ</span>
          </div>
        </div>

        <div class="tab-pane" :class="t==='debruijn'?'active':''">
          <div class="code-block">
<span class="cm">// Â§5-3 De Bruijn ä¹˜æ³•æŸ¥è¡¨æ³• â€” Harley's Algorithm</span>
<span class="cm">// Warren Figure 5-17, æ”¹è¿›ç‰ˆ Figure 5-18</span>
<span class="cm">// åŸç†: De Bruijn åºåˆ— â€” æ¯ä¸ªé•¿åº¦kçš„å­ä¸²æ°å¥½å‡ºç°ä¸€æ¬¡</span>
<span class="cm">// å°† nlz è½¬åŒ–ä¸ºæŸ¥è¡¨: å…ˆç”¨ä¹˜æ³•æå–"æŒ‡çº¹", å†æŸ¥6ä½è¡¨</span>

<span class="cm">// æ­¥éª¤1: å°† x å˜ä¸ºåªæœ‰æœ€é«˜1ä½çš„å½¢å¼ (ç±»ä¼¼ flp2)</span>
<span class="cm">// æ­¥éª¤2: ä¹˜ä»¥ De Bruijn å¸¸æ•°, å–é«˜6ä½ä½œä¸ºè¡¨ç´¢å¼•</span>
<span class="cm">// æ­¥éª¤3: æŸ¥ 64 é¡¹è¡¨, è¿”å› nlz å€¼</span>

<span class="kw">static const char</span> table[<span class="num">64</span>] = {
  <span class="num">32</span>,<span class="num">20</span>,<span class="num">19</span>, u, u,<span class="num">18</span>, u, <span class="num">7</span>,
  <span class="num">10</span>,<span class="num">17</span>, u, u,<span class="num">14</span>, u, <span class="num">6</span>, u,
   u, <span class="num">9</span>, u,<span class="num">16</span>, u, u, <span class="num">1</span>,<span class="num">26</span>,
   u,<span class="num">13</span>, u, u,<span class="num">24</span>, <span class="num">5</span>, u, u,
   u,<span class="num">21</span>, u, <span class="num">8</span>,<span class="num">11</span>, u,<span class="num">15</span>, u,
   u, u, u, <span class="num">2</span>,<span class="num">27</span>, <span class="num">0</span>,<span class="num">25</span>, u,
  <span class="num">22</span>, u,<span class="num">12</span>, u, u, <span class="num">3</span>,<span class="num">28</span>, u,
  <span class="num">23</span>, u, <span class="num">4</span>,<span class="num">29</span>, u, u,<span class="num">30</span>,<span class="num">31</span>
};
<span class="kw">int</span> <span class="fn">nlz_debruijn</span>(<span class="kw">unsigned</span> x) {
  x = x | (x &gt;&gt; <span class="num">1</span>);  <span class="cm">// å°†æœ€é«˜1ä½ä»¥ä¸‹å…¨éƒ¨ç½®1</span>
  x = x | (x &gt;&gt; <span class="num">2</span>);
  x = x | (x &gt;&gt; <span class="num">4</span>);
  x = x | (x &gt;&gt; <span class="num">8</span>);
  x = x | (x &gt;&gt; <span class="num">16</span>); <span class="cm">// x ç°åœ¨æ˜¯ 0...01...1 å½¢å¼</span>
  x = ~x;             <span class="cm">// å–å: 1...10...0</span>
  x = x - (x &gt;&gt; <span class="num">1</span>);  <span class="cm">// åªä¿ç•™æœ€é«˜1ä½</span>
  <span class="kw">return</span> table[(x * <span class="num">0x045BCED1</span>) &gt;&gt; <span class="num">26</span>];
  <span class="cm">// 0x045BCED1 æ˜¯ De Bruijn å¸¸æ•°</span>
  <span class="cm">// = 17 Ã— 65 Ã— 129 Ã— 513 (mod 2^32)</span>
  <span class="cm">// ä¹˜æ³•å°†æœ€é«˜1ä½çš„ä½ç½®æ˜ å°„åˆ°é«˜6ä½</span>
  <span class="cm">// é«˜6ä½æ°å¥½åœ¨0~63å†…å”¯ä¸€, å› æ­¤å¯ä»¥æŸ¥è¡¨</span>
}
<span class="cm">// æŒ‡ä»¤æ•°çº¦15, å«1æ¬¡ä¹˜æ³•+1æ¬¡å†…å­˜è®¿é—®</span>
<span class="cm">// è‹¥æ— ä¹˜æ³•: æ”¹ç”¨ Goryavsky å˜ä½“, çº¯ç§»ä½åŠ æ³•</span>
          </div>
        </div>

        <div class="tab-pane" :class="t==='hw'?'active':''">
          <div class="code-block">
<span class="cm">// Â§5-3 ç¡¬ä»¶ nlz æŒ‡ä»¤ â€” æœ€ä¼˜è§£</span>

<span class="cm">// x86 â€” BSR (Bit Scan Reverse) + LZCNT</span>
<span class="cm">// BSR dst, src: dst = æœ€é«˜1ä½çš„ä½ç½® (0-indexed from LSB)</span>
<span class="cm">// LZCNT dst, src: dst = å‰å¯¼é›¶ä¸ªæ•° (BMI1, Intel Haswell+)</span>
<span class="cm">// æ³¨æ„: BSRåœ¨x=0æ—¶è¡Œä¸ºæœªå®šä¹‰! LZCNTåˆ™å®šä¹‰ä¸º32</span>
<span class="cm">// x86 BSR: 1å‘¨æœŸ, ä½†ä¸LZCNTè¯­ä¹‰ä¸åŒ</span>
<span class="cm">// nlz(x) = 31 - BSR(x)  (xâ‰ 0)</span>

<span class="cm">// C GCC/Clang:</span>
<span class="kw">int</span> <span class="fn">nlz_hw</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">if</span> (x == <span class="num">0</span>) <span class="kw">return</span> <span class="num">32</span>;
  <span class="kw">return</span> __builtin_clz(x);
  <span class="cm">// ç¼–è¯‘åˆ° LZCNT æˆ– BSR å–å†³äº -march=</span>
  <span class="cm">// æ³¨æ„: __builtin_clz(0) æ˜¯ UB!</span>
}

<span class="cm">// å„å¹³å°å¯¹åº”å…³ç³»:</span>
<span class="cm">// x86 (BMI1):   LZCNT   r32, r/m32  (1å‘¨æœŸ)</span>
<span class="cm">// ARM64:        CLZ     Wd, Wn      (1å‘¨æœŸ)</span>
<span class="cm">// RISC-V B-ext: CLZ     rd, rs1     (1å‘¨æœŸ)</span>
<span class="cm">// PowerPC:      CNTLZW  rA, rS      (æœ€æ—©æ”¯æŒ, 1990s)</span>
<span class="cm">// MIPS:         CLZ     rd, rs      (MIPS32 Rev 1)</span>

<span class="cm">// Java: Integer.numberOfLeadingZeros(x)</span>
<span class="cm">// Rust: x.leading_zeros()</span>
<span class="cm">// C++20: std::countl_zero(x)  (æ ‡å‡†åŒ–!)</span>

<span class="cm">// å†å²: IBM System/360 (1964) å°±æœ‰ CLZ æŒ‡ä»¤</span>
<span class="cm">// x86 ç›´åˆ° 2013 (Haswell) æ‰æœ‰æ— æ­§ä¹‰çš„ LZCNT</span>
<span class="cm">// è¿™ 50 å¹´çš„ç©ºç™½å‚¬ç”Ÿäº† Warren Â§5-3 çš„æ‰€æœ‰è½¯ä»¶æ–¹æ³•</span>
          </div>
        </div>
      </div>
    </div>

    <!-- nlz çš„åº”ç”¨ -->
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--p);margin-bottom:.7rem;">
        ğŸ“¦ nlz çš„æ ¸å¿ƒåº”ç”¨åœºæ™¯
      </div>
      <div style="display:flex;flex-direction:column;gap:.55rem;">
        <div style="padding:.6rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--g);margin-bottom:.28rem;">ğŸ“ æ•´æ•° floor(logâ‚‚ x) = 31 - nlz(x)</div>
          <div style="font-size:.77rem;color:#64748b;line-height:1.62;">å“ˆå¸Œè¡¨å®¹é‡èˆå…¥åˆ°2çš„å¹‚ã€Bæ ‘é˜¶æ•°è®¡ç®—ã€IEEEæµ®ç‚¹è§„èŒƒåŒ–ç§»ä½é‡ã€Huffmanæ ‘æ·±åº¦è®¡ç®—ï¼Œå‡ä¾èµ–è¿™ä¸€æ’ç­‰å¼ã€‚</div>
        </div>
        <div style="padding:.6rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--b);margin-bottom:.28rem;">ğŸ”¢ å‘ä¸Šå–æ•´åˆ°2çš„å¹‚ = 1 &lt;&lt; (32 - nlz(x-1))</div>
          <div style="font-size:.77rem;color:#64748b;line-height:1.62;">mallocå¯¹é½ã€GPUç€è‰²å™¨ç¼“å†²åŒºå¤§å°ã€ç½‘ç»œæ•°æ®åŒ…åˆ†æ®µå¤§å°ï¼Œéƒ½éœ€è¦å¿«é€Ÿè®¡ç®—"ä¸å°äºxçš„æœ€å°2çš„å¹‚"ã€‚Warren Â§3-2 çš„ clp2 å°±æ˜¯æ­¤å…¬å¼ã€‚</div>
        </div>
        <div style="padding:.6rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--o);margin-bottom:.28rem;">ğŸŒ³ æ•´æ•°å¹³æ–¹æ ¹åˆå§‹ä¼°è®¡</div>
          <div style="font-size:.77rem;color:#64748b;line-height:1.62;">æ•´æ•° sqrt(x) çš„ç‰›é¡¿è¿­ä»£åˆå§‹å€¼å¯ç”¨ <code style="color:var(--o)">1 &lt;&lt; ((32 - nlz(x)) / 2)</code> ç»™å‡ºï¼Œæ¯”ä»1å¼€å§‹è¿­ä»£æ”¶æ•›å¿«çº¦ logâ‚‚(x)/2 å€ã€‚</div>
        </div>
        <div style="padding:.6rem;background:#010409;border:1px solid #1e293b;border-radius:.35rem;">
          <div style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--p);margin-bottom:.28rem;">ğŸ” å¯†ç å­¦ï¼šå¤§æ•°æ¯”è¾ƒä¸æ¨¡å¹‚</div>
          <div style="font-size:.77rem;color:#64748b;line-height:1.62;">RSA/ECC å¤§æ•°æ¨¡å¹‚è¿ç®—çš„å¾ªç¯æ¬¡æ•° = æŒ‡æ•°çš„ä½é•¿ = 64 - nlz(e)ã€‚OpenSSL çš„ BN_num_bits() åº•å±‚å°±æ˜¯ CLZã€‚å¿«1ä½ = å°‘1æ¬¡æ¨¡ä¹˜ = èŠ‚çœæ•°åå¾®ç§’ã€‚</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• Â§5-4 å°¾éšé›¶ ntz â•â•â• -->
<section id="ntz">
  <div class="sec-header">
    <span class="sec-num">Â§5-4</span>
    <span class="sec-title">å°¾éšé›¶è®¡æ•° â€” Counting Trailing Zeros (ntz / CTZ)</span>
    <div class="sec-divider"></div>
  </div>

  <div class="insight">
    <span class="label">// ntz(x) = æœ€ä½1ä½ä¹‹åæœ‰å¤šå°‘ä¸ª0 = æœ€ä½1ä½çš„ä½ç½®</span>
    <code style="color:var(--o)">ntz(x)</code> ç­‰ä»·äº <code style="color:var(--o)">x &amp; (-x)</code>ï¼ˆéš”ç¦»æœ€ä½1ä½ï¼‰çš„ä½ä½ç½®ï¼Œ
    ä¹Ÿç­‰ä»·äº <code style="color:var(--o)">x</code> èƒ½è¢« <code style="color:var(--o)">2^k</code> æ•´é™¤çš„æœ€å¤§ kã€‚
    Warren ç»™å‡ºäº†æ¯” nlz æ›´å¤šæ ·çš„å®ç°è·¯å¾„ï¼Œå…¶ä¸­æœ€ç²¾å¦™çš„æ˜¯
    <strong>De Bruijn ä¹˜æ³•æŸ¥è¡¨</strong>ï¼šç”¨ä¸€ä¸ª32ä½ De Bruijn åºåˆ—çš„ç‰¹æ®Šä¹˜æ³•ï¼Œ
    å°†"æœ€ä½1ä½çš„ä½ç½®"å”¯ä¸€æ˜ å°„åˆ°ä¸€ä¸ª5ä½ç´¢å¼•ï¼Œåªéœ€1æ¬¡ä¹˜æ³•+1æ¬¡è¡¨æŸ¥æ‰¾ã€‚
    ntz çš„"å°ºå­å‡½æ•°"ï¼ˆruler functionï¼‰åº”ç”¨å°¤ä¸ºæœ‰è¶£ï¼š
    ntz(k) æè¿°äº†æ±‰æ˜ç¼–ç ä¸­ä¸‹ä¸€ä¸ªè¦ç§»åŠ¨çš„ç£ç›˜ï¼Œä»¥åŠæ ¼é›·ç ç”Ÿæˆä¸­ä¸‹ä¸€ä¸ªè¦ç¿»è½¬çš„ä½ã€‚
  </div>

  <!-- ntz äº¤äº’æ¼”ç¤º -->
  <div class="card" style="margin-bottom:1.2rem;" x-data="ntzDemo()">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--o);margin-bottom:.85rem;">
      ğŸ”¬ ntz æ¼”ç¤º â€” å°¾éšé›¶ä¸æœ€ä½1ä½éš”ç¦»
    </div>
    <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-bottom:.75rem;">
      <div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:#475569;margin-bottom:.25rem;">è¾“å…¥å€¼ (hex)</div>
        <input type="text" x-model="hexIn" @input="parseH()"
               style="width:130px;background:#010409;border:1px solid #1e293b;color:var(--o);font-family:'JetBrains Mono',monospace;font-size:.8rem;padding:.28rem .5rem;border-radius:3px;"
               placeholder="0x...">
      </div>
      <div style="display:flex;gap:.35rem;flex-wrap:wrap;margin-top:1rem;">
        <button @click="setV(1)"          class="tab-btn">1</button>
        <button @click="setV(4)"          class="tab-btn">4</button>
        <button @click="setV(0x100)"      class="tab-btn">0x100</button>
        <button @click="setV(0xDEADBEEF)" class="tab-btn">0xDEADBEEF</button>
        <button @click="setV(0x80000000)" class="tab-btn">0x80000000</button>
      </div>
    </div>

    <!-- ä½å›¾ -->
    <div class="bit-row" style="margin-bottom:.5rem;">
      <template x-for="(b,i) in bits" :key="i">
        <div class="bit-cell"
             :class="(31-i) < ntz ? 'warn' : ((31-i) === ntz ? 'one' : (b?'hi':'zero'))"
             x-text="b"
             :title="'bit '+(31-i)"></div>
      </template>
    </div>
    <!-- ä½å·æ ‡ç­¾ -->
    <div style="display:flex;gap:2px;flex-wrap:wrap;margin-bottom:.6rem;">
      <template x-for="(b,i) in bits" :key="i">
        <div style="width:22px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:.45rem;"
             :style="{color:(31-i)===ntz?'var(--o)':'#1e293b'}"
             x-text="31-i"></div>
      </template>
    </div>

    <div style="display:flex;gap:.65rem;flex-wrap:wrap;margin-bottom:.75rem;">
      <div class="stat-box" style="min-width:120px;">
        <div class="stat-val" style="color:var(--o);" x-text="ntz"></div>
        <div class="stat-label">ntz (å°¾éšé›¶)</div>
      </div>
      <div class="stat-box" style="min-width:140px;">
        <div class="stat-val" style="color:var(--g);font-size:1rem;"
             x-text="val32===0?'0':'0x'+(val32 & -val32).toString(16).toUpperCase().padStart(8,'0')"></div>
        <div class="stat-label">x &amp; (-x) æœ€ä½1ä½</div>
      </div>
      <div class="stat-box" style="min-width:120px;">
        <div class="stat-val" style="color:var(--p);" x-text="val32===0?32:ntz"></div>
        <div class="stat-label">æœ€å¤§2^kæ•´é™¤å› å­</div>
      </div>
    </div>

    <!-- å°ºå­å‡½æ•°å¯è§†åŒ– -->
    <div style="background:#010409;border:1px solid #1e293b;border-radius:.45rem;padding:.75rem 1rem;">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:#334155;margin-bottom:.5rem;">
        å°ºå­å‡½æ•° ntz(k), k = 1..16 ï¼ˆæ±‰è¯ºå¡”ç§»ç›˜é¡ºåº / æ ¼é›·ç ç¿»è½¬ä½ï¼‰
      </div>
      <div style="display:flex;gap:3px;flex-wrap:wrap;">
        <template x-for="k in 16" :key="k">
          <div style="text-align:center;min-width:28px;">
            <div style="font-family:'JetBrains Mono',monospace;font-size:.6rem;color:#334155;" x-text="k"></div>
            <div :style="{
                   height: (rulerFn(k)+1)*12+'px',
                   background: ['var(--g)','var(--b)','var(--p)','var(--o)','var(--r)'][Math.min(rulerFn(k),4)],
                   borderRadius:'2px 2px 0 0',
                   marginTop:'2px',
                   opacity:.75
                 }"></div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--o);margin-top:2px;"
                 x-text="rulerFn(k)"></div>
          </div>
        </template>
      </div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:.63rem;color:#334155;margin-top:.4rem;">
        æŸ±é«˜ = ntz(k)ï¼Œè§„å¾‹: æ¯éš”1æ­¥æ’å…¥0ï¼Œæ¯éš”2æ­¥æ’å…¥1ï¼Œæ¯éš”4æ­¥æ’å…¥2...
        â†’ æ±‰è¯ºå¡”ç¬¬kæ­¥ç§»åŠ¨ç£ç›˜ ntz(k)
      </div>
    </div>
  </div>

  <!-- ntz ä»£ç å®ç° -->
  <div class="grid-2">
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--o);margin-bottom:.7rem;">ntz å®ç° â€” å¤šç§æ–¹æ³•</div>
      <div class="code-block">
<span class="cm">// Â§5-4 ntz æ–¹æ³•æ€»è§ˆ</span>

<span class="cm">// æ–¹æ³•1: åˆ©ç”¨ nlz (å…ˆéš”ç¦»æœ€ä½1ä½)</span>
<span class="kw">int</span> <span class="fn">ntz1</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">return</span> <span class="fn">nlz</span>(~x &amp; (x-<span class="num">1</span>));
  <span class="cm">// ~x & (x-1): å°†æœ€ä½1ä½åŠä»¥ä¸‹å…¨éƒ¨å–åå†æ¸…é›¶</span>
  <span class="cm">// ç­‰ä»·äºå°† x çš„å°¾éšé›¶å˜æˆå‰å¯¼é›¶</span>
}

<span class="cm">// æ–¹æ³•2: x & (-x) éš”ç¦»æœ€ä½1ä½ + nlz</span>
<span class="kw">int</span> <span class="fn">ntz2</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">if</span> (x == <span class="num">0</span>) <span class="kw">return</span> <span class="num">32</span>;
  <span class="kw">return</span> <span class="num">31</span> - <span class="fn">nlz</span>(x &amp; -(<span class="kw">int</span>)x);
  <span class="cm">// x & (-x): åªä¿ç•™æœ€ä½1ä½</span>
  <span class="cm">// 31 - nlz: æœ€ä½1ä½çš„ä½ç½®å³å°¾éšé›¶æ•°</span>
}

<span class="cm">// æ–¹æ³•3: äºŒåˆ†æœç´¢ (ä»¿ç…§ nlz)</span>
<span class="kw">int</span> <span class="fn">ntz_bisect</span>(<span class="kw">unsigned</span> x) {
  <span class="kw">int</span> n = <span class="num">1</span>;
  <span class="kw">if</span> (x == <span class="num">0</span>) <span class="kw">return</span> <span class="num">32</span>;
  <span class="kw">if</span> ((x &amp; <span class="num">0x0000FFFF</span>)==<span class="num">0</span>) { n+=<span class="num">16</span>; x&gt;&gt;=<span class="num">16</span>; }
  <span class="kw">if</span> ((x &amp; <span class="num">0x000000FF</span>)==<span class="num">0</span>) { n+= <span class="num">8</span>; x&gt;&gt;= <span class="num">8</span>; }
  <span class="kw">if</span> ((x &amp; <span class="num">0x0000000F</span>)==<span class="num">0</span>) { n+= <span class="num">4</span>; x&gt;&gt;= <span class="num">4</span>; }
  <span class="kw">if</span> ((x &amp; <span class="num">0x00000003</span>)==<span class="num">0</span>) { n+= <span class="num">2</span>; x&gt;&gt;= <span class="num">2</span>; }
  <span class="kw">return</span> n - (x &amp; <span class="num">1</span>);
}

<span class="cm">// æ–¹æ³•4: ç¡¬ä»¶</span>
<span class="cm">// __builtin_ctz(x)  (xâ‰ 0, å¦åˆ™UB)</span>
<span class="cm">// x86: BSF rd, rs (Bit Scan Forward)</span>
<span class="cm">// x86 BMI1: TZCNT rd, rs  (x=0æ—¶è¿”å›32)</span>
<span class="cm">// ARM64: RBIT + CLZ (åè½¬ä½å†æ•°å‰å¯¼é›¶)</span>
<span class="cm">// RISC-V B: CTZ rd, rs</span>
<span class="cm">// C++20: std::countr_zero(x)</span>
      </div>
    </div>
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--b);margin-bottom:.7rem;">De Bruijn åºåˆ—æŸ¥è¡¨ ntz â€” æœ€ç²¾å¦™å®ç°</div>
      <div class="code-block">
<span class="cm">// Â§5-4 Warren Figure 5-22: De Bruijn ntz</span>
<span class="cm">// æ ¸å¿ƒæ€æƒ³: De Bruijn åºåˆ—çš„æ¯ä¸ªè¿ç»­å­ä¸²å”¯ä¸€</span>
<span class="cm">// 0x077CB531 æ˜¯ä¸€ä¸ª32ä½ De Bruijn åºåˆ—å¸¸æ•°</span>
<span class="cm">// å°† (x & -x) ä¹˜ä»¥å®ƒ, å–é«˜5ä½ â†’ å”¯ä¸€æ˜ å°„åˆ°0~31</span>

<span class="kw">static const int</span> deBruijn_ntz[<span class="num">32</span>] = {
   <span class="num">0</span>,  <span class="num">1</span>, <span class="num">28</span>,  <span class="num">2</span>, <span class="num">29</span>, <span class="num">14</span>, <span class="num">24</span>,  <span class="num">3</span>,
  <span class="num">30</span>, <span class="num">22</span>, <span class="num">20</span>, <span class="num">15</span>, <span class="num">25</span>, <span class="num">17</span>,  <span class="num">4</span>,  <span class="num">8</span>,
  <span class="num">31</span>, <span class="num">27</span>, <span class="num">13</span>, <span class="num">23</span>, <span class="num">21</span>, <span class="num">19</span>, <span class="num">16</span>,  <span class="num">7</span>,
  <span class="num">26</span>, <span class="num">12</span>, <span class="num">18</span>,  <span class="num">6</span>, <span class="num">11</span>,  <span class="num">5</span>, <span class="num">10</span>,  <span class="num">9</span>
};

<span class="kw">int</span> <span class="fn">ntz_debruijn</span>(<span class="kw">unsigned</span> v) {
  <span class="kw">return</span> deBruijn_ntz[
    ((v &amp; -(<span class="kw">int</span>)v) * <span class="num">0x077CB531u</span>) &gt;&gt; <span class="num">27</span>
  ];
}
<span class="cm">// æ­¥éª¤è§£æ (ä»¥ v=0x00000100 ä¸ºä¾‹):</span>
<span class="cm">// 1. v & -v = 0x00000100  (åªç•™æœ€ä½1ä½)</span>
<span class="cm">// 2. * 0x077CB531</span>
<span class="cm">//    = 0x077CB531 << 8 = 0xCB531000(ä½32ä½)</span>
<span class="cm">// 3. >> 27 = 0xCB531000 >> 27 = 0x19 = 25</span>
<span class="cm">// 4. deBruijn_ntz[25] = 8  âœ“ (0x100 = bit 8)</span>

<span class="cm">// ä¸ºä»€ä¹ˆå« De Bruijn?</span>
<span class="cm">// 0x077CB531 çš„32ä½äºŒè¿›åˆ¶å±•å¼€æ˜¯ä¸€ä¸ª De Bruijn</span>
<span class="cm">// åºåˆ— B(2,5): æ¯ä¸ª5ä½å­ä¸² 00000~11111 æ°å¥½</span>
<span class="cm">// å‡ºç°ä¸€æ¬¡ã€‚ä¹˜ä»¥ 2^k (= å·¦ç§»kä½) æ°å¥½å°†ç¬¬kä¸ª</span>
<span class="cm">// 5ä½å­ä¸²ç§»åˆ°é«˜5ä½, ä½¿å…¶æˆä¸ºå”¯ä¸€çš„è¡¨ç´¢å¼•ã€‚</span>
<span class="cm">// åªéœ€32é¡¹è¡¨, 1æ¬¡ä¹˜æ³•, 1æ¬¡ç§»ä½, 1æ¬¡æŸ¥è¡¨!</span>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â• Â§5-5 å†å²ä¸æ¨ªå‘æ¯”è¾ƒ â•â•â• -->
<section id="history">
  <div class="sec-header">
    <span class="sec-num">Â§5-5</span>
    <span class="sec-title">å†å²æº¯æºä¸è·¨å¹³å°å¯¹æ¯”</span>
    <div class="sec-divider"></div>
  </div>

  <div class="insight">
    <span class="label">// FROM IBM STRETCH (1960) TO RISC-V B-EXTENSION (2021)</span>
    popcount / CLZ / CTZ è¿™ä¸‰ä¸ªåŸè¯­çš„å†å²ï¼Œæ˜¯ä¸€éƒ¨<strong>ç¡¬ä»¶è¶…è¶Šè½¯ä»¶æ™ºæ…§ã€è½¯ä»¶åˆåå“ºç¡¬ä»¶è®¾è®¡</strong>çš„å¾ªç¯å²ã€‚
    IBM Stretchï¼ˆ1961ï¼‰ç¬¬ä¸€æ¬¡æŠŠ popcount åšæˆç¡¬ä»¶æŒ‡ä»¤ï¼Œä½† x86 åœ¨ 2008 å¹´æ‰è·Ÿä¸Šï¼ˆPOPCNTï¼‰ã€‚
    è¿™ 47 å¹´çš„ç©ºç™½ï¼Œå‚¬ç”Ÿäº† HAKMEMã€Warren Â§5-1 è¿™äº›ä»£ä»£ç›¸ä¼ çš„è½¯ä»¶æŠ€å·§ã€‚
    ä»Šå¤©è¿™äº›å‡½æ•°å·²ç»åœ¨ C++20 çš„ <code style="color:var(--o)">&lt;bit&gt;</code> å¤´æ–‡ä»¶ä¸­è¢«æ ‡å‡†åŒ–â€”â€”
    å†å²ç»•äº†ä¸€ä¸ªå¤§åœˆï¼Œä½†æ¯ä¸€ä¸ªå¼¯é“éƒ½ç•™ä¸‹äº†å€¼å¾—ç»†å“çš„å·¥ç¨‹ç¾å­¦ã€‚
  </div>

  <!-- æ—¶é—´çº¿ -->
  <div class="card" style="margin-bottom:1.2rem;">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--g);margin-bottom:1rem;">ğŸ“… ä½è®¡æ•°å‡½æ•°çš„å†å²æ—¶é—´çº¿</div>
    <div style="position:relative;padding-left:1.4rem;">
      <div style="position:absolute;left:.6rem;top:0;bottom:0;width:1px;background:linear-gradient(180deg,var(--g),var(--b),var(--p),var(--o));opacity:.3;"></div>
      <template x-for="(ev,i) in timeline" :key="i">
        <div style="position:relative;margin-bottom:1.1rem;padding-left:.5rem;">
          <div style="position:absolute;left:-1.15rem;top:.35rem;width:7px;height:7px;border-radius:50%;"
               :style="{background:ev.color,boxShadow:'0 0 5px '+ev.color}"></div>
          <div style="display:flex;align-items:baseline;gap:.5rem;flex-wrap:wrap;">
            <span style="font-family:'JetBrains Mono',monospace;font-size:.68rem;" :style="{color:ev.color}" x-text="ev.year"></span>
            <span style="font-size:.83rem;font-weight:600;color:#e2e8f0;" x-text="ev.title"></span>
          </div>
          <div style="font-size:.78rem;color:#64748b;line-height:1.65;margin-top:.18rem;" x-text="ev.desc"></div>
        </div>
      </template>
    </div>
  </div>

  <!-- è·¨å¹³å°æŒ‡ä»¤å¯¹æ¯”è¡¨ -->
  <div class="card" style="margin-bottom:1.2rem;">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--b);margin-bottom:.75rem;">ğŸ”§ å„å¹³å°ä½è®¡æ•°æŒ‡ä»¤å¯¹æ¯”</div>
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:.72rem;">
        <thead>
          <tr style="border-bottom:1px solid #1e293b;">
            <th style="text-align:left;padding:.4rem .6rem;color:#475569;">å¹³å°</th>
            <th style="text-align:left;padding:.4rem .6rem;color:var(--g);">popcount</th>
            <th style="text-align:left;padding:.4rem .6rem;color:var(--b);">CLZ / nlz</th>
            <th style="text-align:left;padding:.4rem .6rem;color:var(--o);">CTZ / ntz</th>
            <th style="text-align:left;padding:.4rem .6rem;color:var(--p);">å¯ç”¨å¹´ä»½</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(row,i) in archTable" :key="i">
            <tr :style="{borderBottom:'1px solid #0f172a',background:i%2===0?'transparent':'rgba(0,255,136,.02)'}">
              <td style="padding:.38rem .6rem;color:#94a3b8;" x-text="row.arch"></td>
              <td style="padding:.38rem .6rem;" :style="{color:row.pop?'var(--g)':'#334155'}" x-text="row.pop||'â€”'"></td>
              <td style="padding:.38rem .6rem;" :style="{color:row.clz?'var(--b)':'#334155'}" x-text="row.clz||'â€”'"></td>
              <td style="padding:.38rem .6rem;" :style="{color:row.ctz?'var(--o)':'#334155'}" x-text="row.ctz||'â€”'"></td>
              <td style="padding:.38rem .6rem;color:#475569;" x-text="row.year"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <!-- å›¾è¡¨ï¼šå„å®ç°æŒ‡ä»¤æ•° -->
  <div class="card">
    <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--o);margin-bottom:.5rem;">
      ğŸ“Š nlz å„å®ç°æ–¹æ¡ˆæŒ‡ä»¤æ•°ä¸æ€§èƒ½å¯¹æ¯”
    </div>
    <div id="chart-nlz" style="width:100%;height:220px;"></div>
  </div>
</section>

<!-- â•â•â• Â§5-6 æ·±åº¦ç‚¹è¯„ â•â•â• -->
<section id="critique">
  <div class="sec-header">
    <span class="sec-num">Â§CRIT</span>
    <span class="sec-title">æ·±åº¦ç‚¹è¯„ â€” ç¬¬5ç« çš„ç²¾åä¸å¯ç¤º</span>
    <div class="sec-divider"></div>
  </div>

  <div class="critic-box" style="margin-bottom:1.2rem;">
    <h3>ç¬¬5ç« ï¼šå…­åå¹´æ™ºæ…§çš„ç»“æ™¶ï¼Œä»HAKMEMåˆ°C++20</h3>
    <div class="critic-item">
      <div class="ci-title">âœ¦ åˆ†æ²» popcount æ˜¯"å¹¶è¡Œæ€ç»´"çš„æ•™ç§‘ä¹¦</div>
      <p>Warren Â§5-1 çš„åˆ†æ²»æ–¹æ³•çš„æœ¬è´¨æ˜¯æŠŠ32ä¸ªä¸²è¡ŒåŠ æ³•å™¨åœ¨ä¸€ä¸ªå¯„å­˜å™¨å†…åŒæ—¶å¹¶è¡Œè¿è¡Œã€‚
      è¿™ä¸ªæ€è·¯ç›´æ¥å¯¹åº”äº† Kogge-Stone å¹¶è¡Œå‰ç¼€åŠ æ³•å™¨ç”µè·¯ã€‚
      è½¯ä»¶å·¥ç¨‹å¸ˆä¹ æƒ¯äº†"å¾ªç¯+è®¡æ•°å™¨"çš„æ€ç»´å®šåŠ¿ï¼Œè€Œè¿™ä¸ªç®—æ³•å‘Šè¯‰ä½ ï¼š
      åªè¦é—®é¢˜å…·æœ‰ä½çº§ç‹¬ç«‹æ€§ï¼Œå°±å¯ä»¥åœ¨å•ä¸ª ALU å‘¨æœŸå†…å®ŒæˆåŸæœ¬éœ€è¦32æ­¥çš„å·¥ä½œã€‚
      è¿™ç§"æ•°æ®å¹¶è¡Œ"æ€æƒ³æ˜¯ SIMDã€GPU Warpã€TPU çŸ©é˜µå•å…ƒçš„å…±åŒç¥–å…ˆã€‚</p>
    </div>
    <div class="critic-item">
      <div class="ci-title">âœ¦ De Bruijn æŸ¥è¡¨æ³•ï¼šæ•°å­¦ä¸å·¥ç¨‹çš„å®Œç¾æ¥å»</div>
      <p>De Bruijn åºåˆ—åŸæœ¬æ˜¯ç»„åˆæ•°å­¦ä¸­çš„çº¯ç†è®ºå¯¹è±¡ï¼ˆ1940å¹´ä»£è·å…°æ•°å­¦å®¶ Nicolaas de Bruijn ç ”ç©¶çš„ï¼‰ï¼Œ
      å…­åå¹´åè¢« Robert Harleyï¼ˆ1996å¹´ï¼‰å‘ç°å¯ä»¥ç”¨æ¥è§£å†³ nlz/ntz çš„é«˜æ•ˆå®ç°é—®é¢˜ã€‚
      ä¸€æ¬¡ä¹˜æ³• + ä¸€æ¬¡ç§»ä½ + ä¸€æ¬¡è¡¨æŸ¥æ‰¾ï¼Œä¸éœ€è¦ä»»ä½•åˆ†æ”¯ï¼Œä¸éœ€è¦ä»»ä½•ç¡¬ä»¶æ‰©å±•ã€‚
      è¿™ç§"æŠŠçº¯æ•°å­¦ç†è®ºç›´æ¥å˜æˆå·¥ç¨‹æŒ‡ä»¤åºåˆ—"çš„æƒŠå–œæ„Ÿï¼Œæ­£æ˜¯è¿™æœ¬ä¹¦æœ€ä»¤äººç€è¿·çš„åœ°æ–¹ã€‚</p>
    </div>
    <div class="critic-item">
      <div class="ci-title">âœ¦ æµ®ç‚¹å€Ÿç”¨æ³•ï¼šè·¨åŸŸå€Ÿé¸¡ä¸‹è›‹çš„æå®¢ç²¾ç¥</div>
      <p>ç”¨ IEEE 754 double çš„æŒ‡æ•°å­—æ®µæ¥è®¡ç®—æ•´æ•°å¯¹æ•°ï¼Œæ˜¯ä¸€ç§ä»¤å¼ºè¿«ç—‡ç¨‹åºå‘˜æ—¢çˆ±åˆæ¨çš„æŠ€å·§ã€‚
      å®ƒçš„æ­£ç¡®æ€§ä¾èµ–äºä¸€ä¸ªæ·±åˆ»çš„è§‚å¯Ÿï¼šæµ®ç‚¹æ•°çš„è§„èŒƒåŒ–æŒ‡æ•°æœ¬è´¨ä¸Šå°±æ˜¯"æœ€é«˜æœ‰æ•ˆä½çš„ä½ç½®"ã€‚
      ä½†å…¶ä»£ä»·æ˜¯ï¼šä»£ç ä¾èµ–æœªå®šä¹‰è¡Œä¸ºï¼ˆtype-punningï¼‰ï¼Œè·¨ ISA çš„å¤§å°ç«¯é—®é¢˜ï¼Œ
      ä»¥åŠæ•´æ•°å’Œæµ®ç‚¹å¯„å­˜å™¨ä¹‹é—´æ˜‚è´µçš„æ•°æ®è½¬ç§»ã€‚
      Warren ç”¨æ•´æ•´ä¸€é¡µè®¨è®ºå…¶"ä¸ç¨³å®šæ€§"â€”â€”è¿™æœ¬èº«å°±æ˜¯å¯¹ç¼–ç¨‹å®è·µè¯šå®æ€§çš„ä¸€ç§ç¤ºèŒƒã€‚</p>
    </div>
    <div class="critic-item">
      <div class="ci-title">âœ¦ å°ºå­å‡½æ•°ä¸æ±‰è¯ºå¡”ï¼šæ„æƒ³ä¸åˆ°çš„è·¨å­¦ç§‘ç»Ÿä¸€</div>
      <p><code>ntz(k)</code> = k ä¸­2çš„æœ€é«˜æ¬¡å¹‚å› å­ = "å°ºå­å‡½æ•°"ï¼Œæè¿°äº†ä¸€æŠŠæ ‡å‡†å°ºå­ä¸Šå„åˆ»åº¦çº¿çš„é«˜åº¦ã€‚
      Warren æŒ‡å‡ºå®ƒåŒæ—¶è§£å†³äº†ä¸‰ä¸ªçœ‹ä¼¼æ¯«æ— å…³è”çš„é—®é¢˜ï¼šæ±‰è¯ºå¡”ç§»ç›˜é¡ºåºã€æ ¼é›·ç ç¿»è½¬ä½ã€Gosper ç¯è·¯æ£€æµ‹ç®—æ³•ã€‚
      è¿™ç§"ä¸€ä¸ªå‡½æ•°ï¼Œå¤šç§è§£é‡Š"çš„å¤šæ€æ€§ï¼Œæ˜¯è®¡ç®—æœºç§‘å­¦ä¸­æœ€ç¾çš„ç°è±¡ä¹‹ä¸€ã€‚
      æœ‰å¤šå°‘å·¥ç¨‹å¸ˆåœ¨å†™æ±‰è¯ºå¡”é€’å½’æ—¶ï¼Œä»æœªæ„è¯†åˆ°è‡ªå·±çš„é€’å½’è°ƒç”¨æ ˆå°±æ˜¯ä¸€æ£µ ntz çš„å†³ç­–æ ‘ï¼Ÿ</p>
    </div>
    <div class="critic-item">
      <div class="ci-title">âš  æ—¶ä»£å±€é™ï¼šç¡¬ä»¶è¿½ä¸Šæ¥äº†ï¼Œä½†ä¹¦çš„ä»·å€¼æ²¡æœ‰æ¶ˆå¤±</div>
      <p>x86 POPCNTï¼ˆ2008ï¼‰ã€LZCNT/TZCNTï¼ˆ2013ï¼‰ã€C++20 <code>&lt;bit&gt;</code>ï¼ˆ2020ï¼‰ã€
      RISC-V B æ‰©å±•ï¼ˆ2021ï¼‰çš„ç›¸ç»§æ ‡å‡†åŒ–ï¼Œè®©æœ¬ç« å¤§éƒ¨åˆ†"è½¯ä»¶æŠ€å·§"å˜æˆäº†åšç‰©é¦†å±•å“ã€‚
      ä½†è¿™æ°æ°è¯´æ˜ï¼šWarren è¿™æœ¬ä¹¦æ‰€è®°å½•çš„ï¼Œæ˜¯ä¸€ä»£å·¥ç¨‹å¸ˆåœ¨ç¡¬ä»¶ç¼ºä½æ—¶ç”¨æ™ºæ…§å¡«è¡¥ç©ºç™½çš„å†å²ã€‚
      ç†è§£è¿™äº›æŠ€å·§çš„åŸç†ï¼Œä¸æ˜¯ä¸ºäº†ä»Šå¤©è¿˜ç”¨å®ƒä»¬ï¼Œè€Œæ˜¯ä¸ºäº†ç†è§£ï¼šå½“ä½ é¢å¯¹ä¸€ä¸ªæ²¡æœ‰ç°æˆæŒ‡ä»¤çš„æ–°é—®é¢˜æ—¶ï¼Œ
      åº”è¯¥æ€æ ·æ€è€ƒã€‚è¿™ç§"ç”¨ç°æœ‰åŸè¯­ç»„åˆå‡ºæ–°åŸè¯­"çš„èƒ½åŠ›ï¼Œæ‰æ˜¯æœ¬ç« çœŸæ­£çš„é—äº§ã€‚</p>
    </div>
  </div>

  <!-- é›·è¾¾å›¾ + nlz å„æ–¹æ³•å¯¹æ¯”å›¾ -->
  <div class="grid-2">
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--p);margin-bottom:.5rem;">
        ğŸ“Š ç¬¬5ç« å„å°èŠ‚ç»¼åˆè¯„åˆ†
      </div>
      <div id="chart-radar" style="width:100%;height:280px;"></div>
    </div>
    <div class="card">
      <div style="font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--b);margin-bottom:.5rem;">
        ğŸ“Š popcount å„æ–¹æ³•ç›¸å¯¹æ€§èƒ½ï¼ˆæ•°å€¼è¶Šä½è¶Šå¿«ï¼ŒSkylake å®æµ‹ï¼‰
      </div>
      <div id="chart-perf" style="width:100%;height:280px;"></div>
    </div>
  </div>
</section>

<!-- å¯¼èˆª -->
<div style="max-width:1100px;margin:0 auto;padding:0 1.5rem 3rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
  <a href="ch04.html"
     style="display:flex;align-items:center;gap:.6rem;padding:.75rem 1.4rem;background:var(--card);border:1px solid #1e293b;border-radius:.6rem;text-decoration:none;color:#94a3b8;font-family:'JetBrains Mono',monospace;font-size:.78rem;transition:all .2s;"
     onmouseover="this.style.borderColor='rgba(0,255,136,.35)';this.style.color='var(--g)'"
     onmouseout="this.style.borderColor='#1e293b';this.style.color='#94a3b8'">
    â† Ch.04 Â· ç®—æœ¯è¾¹ç•Œ
  </a>
  <div style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:#1e293b;">Chapter 05 / Hacker's Delight</div>
  <a href="ch06.html"
     style="display:flex;align-items:center;gap:.6rem;padding:.75rem 1.4rem;background:var(--card);border:1px solid #1e293b;border-radius:.6rem;text-decoration:none;color:#94a3b8;font-family:'JetBrains Mono',monospace;font-size:.78rem;transition:all .2s;"
     onmouseover="this.style.borderColor='rgba(0,255,136,.35)';this.style.color='var(--g)'"
     onmouseout="this.style.borderColor='#1e293b';this.style.color='#94a3b8'">
    Ch.06 Â· æœç´¢å­— â†’
  </a>
</div>

<footer>
  <div>// HACKER'S DELIGHT â€” Chapter 05 Â· Counting Bits</div>
  <div style="margin-top:.4rem;">Interactive Study Notes Â· Alpine.js + ECharts Â· <a href="index.html">è¿”å›ç›®å½•</a></div>
</footer>

</div><!-- #app -->

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å…¨å±€ Alpine æ ¹ç»„ä»¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function app() {
  return {
    timeline: [
      {year:'1961',color:'var(--g)', title:'IBM Stretch â€” ç¬¬ä¸€æ¡ç¡¬ä»¶ popcount æŒ‡ä»¤',
       desc:'IBM 7030 Stretch è¶…çº§è®¡ç®—æœºç‡å…ˆå°†"è®¡æ•°1ä½æ•°"å®ç°ä¸ºå•æ¡æœºå™¨æŒ‡ä»¤ï¼Œç”¨äºç§‘å­¦è®¡ç®—å’Œå¯†ç åˆ†æï¼ˆNSAéœ€æ±‚é©±åŠ¨ï¼‰ã€‚'},
      {year:'1972',color:'var(--b)', title:'HAKMEM Memo â€” MIT AI Lab çš„é»‘å®¢ç§˜ç¬ˆ',
       desc:'Gosperã€Beelerã€Schroeppel åœ¨ HAKMEM item 169 ä¸­è®°å½•äº† mod-63 popcount æŠ€å·§ã€‚è¿™ä»½å¤‡å¿˜å½•æˆä¸ºåä¸–ä½æ“ä½œæŠ€å·§çš„åœ£ç»ã€‚'},
      {year:'1987',color:'var(--p)', title:'Mycroft â€” comp.arch åˆ†æ²» popcount',
       desc:'Alan Mycroft åœ¨ Usenet comp.arch ä¸­å‘å¸ƒäº† 5 æ­¥åˆ†æ²» popcount ç®—æ³•çš„æ—©æœŸå˜ä½“ï¼Œè¢« Warren åœ¨ä¹¦ä¸­å¼•ç”¨ã€‚'},
      {year:'1996',color:'var(--o)', title:'Harley â€” CSA + De Bruijn nlz ç®—æ³•',
       desc:'Robert Harley åœ¨ comp.arch newsgroup ä¸­æå‡ºå°†è¿›ä½ä¿å­˜åŠ æ³•å™¨ç”¨äºæ•°ç»„ popcountï¼Œå¹¶å‘ç° De Bruijn ä¹˜æ³•è¡¨ç´¢å¼•å¯è§£å†³ nlzã€‚'},
      {year:'1997',color:'var(--g)', title:'Seal â€” 7å…ƒç´  CSA æ•°ç»„ popcount',
       desc:'David Seal å±•ç¤ºäº†å¤„ç†7å…ƒç´ æ•°ç»„çš„æœ€ä¼˜ CSA å®‰æ’ï¼Œè¿›ä¸€æ­¥å®Œå–„äº† Harley çš„æ–¹æ³•ã€‚'},
      {year:'2002',color:'var(--b)', title:"Hacker's Delight ç¬¬1ç‰ˆ â€” ç³»ç»ŸåŒ–æ•´ç†",
       desc:'Warren å°†åˆ†æ•£åœ¨å„ newsgroupã€memo ä¸­çš„ä½è®¡æ•°æŠ€å·§ç³»ç»ŸåŒ–ï¼Œç¬¬5ç« æˆä¸ºè¯¥é¢†åŸŸæœ€æƒå¨çš„å‚è€ƒèµ„æ–™ã€‚'},
      {year:'2008',color:'var(--p)', title:'Intel Nehalem â€” x86 POPCNT æŒ‡ä»¤',
       desc:'Intel åœ¨ Nehalem å¾®æ¶æ„ä¸­å¼•å…¥ POPCNT æŒ‡ä»¤ï¼ˆSSE4.2ï¼‰ï¼Œ1ä¸ªå‘¨æœŸå®Œæˆ32/64ä½ popcountã€‚è· IBM Stretch å·²ç»è¿‡å»äº† 47 å¹´ã€‚'},
      {year:'2013',color:'var(--o)', title:'Intel Haswell â€” LZCNT / TZCNT (BMI1)',
       desc:'Haswell å¼•å…¥ BMI1 æ‰©å±•ï¼ŒLZCNT/TZCNT ç»ˆäºæ— æ­§ä¹‰åœ°å®ç°äº† nlz/ntzï¼ˆBSR/BSF åœ¨ x=0 æ—¶è¡Œä¸ºæœªå®šä¹‰ï¼‰ã€‚'},
      {year:'2020',color:'var(--r)', title:'C++20 â€” <bit> å¤´æ–‡ä»¶æ ‡å‡†åŒ–',
       desc:'std::popcountã€std::countl_zeroï¼ˆCLZï¼‰ã€std::countr_zeroï¼ˆCTZï¼‰é¦–æ¬¡è¿›å…¥ C++ æ ‡å‡†ï¼Œç»“æŸäº†è·¨å¹³å°ä½è®¡æ•°çš„æ··ä¹±çŠ¶æ€ã€‚'},
      {year:'2021',color:'var(--g)', title:'RISC-V B æ‰©å±• â€” CPOP / CLZ / CTZ',
       desc:'RISC-V ä½æ“ä½œæ‰©å±•ï¼ˆB-extensionï¼‰å†»ç»“ï¼ŒCPOPï¼ˆpopcountï¼‰ã€CLZã€CTZ æˆä¸ºå¼€æ”¾ ISA çš„æ ‡å‡†é…ç½®ã€‚'}
    ],
    archTable: [
      {arch:'IBM Stretch (1961)', pop:'POPCNT',  clz:'â€”',      ctz:'â€”',      year:'1961'},
      {arch:'IBM System/360',     pop:'â€”',       clz:'â€”',      ctz:'â€”',      year:'1964'},
      {arch:'PowerPC/POWER',      pop:'â€”',       clz:'CNTLZW', ctz:'â€”',      year:'1990'},
      {arch:'MIPS32 (Rev.1)',     pop:'â€”',       clz:'CLZ',    ctz:'CLO',    year:'2001'},
      {arch:'ARMv5T',             pop:'â€”',       clz:'CLZ',    ctz:'â€”',      year:'1998'},
      {arch:'ARM64 (AArch64)',    pop:'CNT+ADDV',clz:'CLZ',    ctz:'RBIT+CLZ',year:'2011'},
      {arch:'x86 (SSE4.2)',       pop:'POPCNT',  clz:'LZCNT*', ctz:'BSF',    year:'2008'},
      {arch:'x86 (BMI1)',         pop:'POPCNT',  clz:'LZCNT',  ctz:'TZCNT',  year:'2013'},
      {arch:'RISC-V B-ext',       pop:'CPOP',    clz:'CLZ',    ctz:'CTZ',    year:'2021'},
      {arch:'WebAssembly',        pop:'i32.popcnt',clz:'i32.clz',ctz:'i32.ctz',year:'2019'},
    ],
    init() {
      this.$nextTick(() => {
        initBg();
        initProgress();
        initDotNav();
        initScrollFade();
        this.$nextTick(() => {
          initChartPop();
          initChartNlz();
          initChartRadar();
          initChartPerf();
        });
      });
    }
  };
}

/* â•â• å­ç»„ä»¶ â•â• */
function popcountDemo() {
  return {
    hexInput: '0xDEADBEEF',
    val: 0xDEADBEEF,
    parseHex() {
      const v = parseInt(this.hexInput, 16);
      if (!isNaN(v)) this.val = v >>> 0;
    },
    setVal(v) { this.val = v >>> 0; this.hexInput = '0x' + v.toString(16).toUpperCase().padStart(8,'0'); },
    get bits32() {
      return Array.from({length:32},(_,i)=>((this.val>>>(31-i))&1));
    },
    get popcount() {
      let x = this.val >>> 0;
      x = x - ((x >>> 1) & 0x55555555);
      x = (x & 0x33333333) + ((x >>> 2) & 0x33333333);
      x = (x + (x >>> 4)) & 0x0F0F0F0F;
      x = x + (x >>> 8);
      x = x + (x >>> 16);
      return x & 0x3F;
    },
    get step1Groups() {
      // æ¯2ä½ä¸€ç»„ï¼Œæ˜¾ç¤ºè¯¥2ä½ä¸­1çš„ä¸ªæ•°ï¼ˆ2ä½äºŒè¿›åˆ¶ï¼‰
      const groups = [];
      for (let i = 0; i < 16; i++) {
        const hi = (this.val >>> (31 - i*2)) & 1;
        const lo = (this.val >>> (30 - i*2)) & 1;
        const cnt = hi + lo;
        groups.push([cnt >> 1, cnt & 1]);
      }
      return groups;
    },
    get step2Groups() {
      // æ¯4ä½ä¸€ç»„ï¼Œæ˜¾ç¤ºè¯¥4ä½ä¸­1çš„ä¸ªæ•°ï¼ˆ4ä½äºŒè¿›åˆ¶ï¼‰
      const groups = [];
      for (let i = 0; i < 8; i++) {
        const nibble = (this.val >>> (28 - i*4)) & 0xF;
        const cnt = ((nibble >> 3)&1)+((nibble>>2)&1)+((nibble>>1)&1)+(nibble&1);
        groups.push([cnt>>3, (cnt>>2)&1, (cnt>>1)&1, cnt&1]);
      }
      return groups;
    },
    get step3Groups() {
      // æ¯8ä½ä¸€ç»„ï¼Œæ˜¾ç¤ºè¯¥å­—èŠ‚ä¸­1çš„ä¸ªæ•°ï¼ˆ8ä½äºŒè¿›åˆ¶ï¼‰
      const groups = [];
      for (let i = 0; i < 4; i++) {
        const byte_ = (this.val >>> (24 - i*8)) & 0xFF;
        let cnt = 0;
        for (let b = 0; b < 8; b++) cnt += (byte_ >> b) & 1;
        groups.push(Array.from({length:8},(_,j)=>(cnt>>>(7-j))&1));
      }
      return groups;
    }
  };
}

function parityDemo() {
  return {
    hexIn: '0xDEADBEEF',
    val32: 0xDEADBEEF >>> 0,
    parse() {
      const v = parseInt(this.hexIn, 16);
      if (!isNaN(v)) this.val32 = v >>> 0;
    },
    get parity() {
      let x = this.val32;
      x ^= x >>> 16;
      x ^= x >>> 8;
      x ^= x >>> 4;
      x ^= x >>> 2;
      x ^= x >>> 1;
      return x & 1;
    },
    get steps() {
      const arr = [];
      let x = this.val32;
      arr.push({label:'åŸå§‹å€¼', val:x, bits:Array.from({length:32},(_,i)=>(x>>>(31-i))&1)});
      x ^= x >>> 16;
      arr.push({label:'^ >> 16', val:x>>>0, bits:Array.from({length:32},(_,i)=>((x>>>0)>>>(31-i))&1)});
      x ^= x >>> 8;
      arr.push({label:'^ >> 8',  val:x>>>0, bits:Array.from({length:32},(_,i)=>((x>>>0)>>>(31-i))&1)});
      x ^= x >>> 4;
      arr.push({label:'^ >> 4',  val:x>>>0, bits:Array.from({length:32},(_,i)=>((x>>>0)>>>(31-i))&1)});
      x ^= x >>> 2;
      arr.push({label:'^ >> 2',  val:x>>>0, bits:Array.from({length:32},(_,i)=>((x>>>0)>>>(31-i))&1)});
      x ^= x >>> 1;
      arr.push({label:'^ >> 1',  val:x>>>0, bits:Array.from({length:32},(_,i)=>((x>>>0)>>>(31-i))&1)});
      return arr;
    }
  };
}

function nlzDemo() {
  return {
    hexIn: '0x00008000',
    val32: 0x00008000,
    parseH() {
      const v = parseInt(this.hexIn, 16);
      if (!isNaN(v)) this.val32 = v >>> 0;
    },
    setV(v) {
      this.val32 = v >>> 0;
      this.hexIn = '0x' + (v >>> 0).toString(16).toUpperCase().padStart(8,'0');
    },
    get bits() { return Array.from({length:32},(_,i)=>((this.val32>>>(31-i))&1)); },
    get nlz() {
      if (this.val32 === 0) return 32;
      let n = 0, x = this.val32;
      if (x <= 0x0000FFFF) { n += 16; x <<= 16; }
      if (x <= 0x00FFFFFF) { n +=  8; x <<=  8; }
      if (x <= 0x0FFFFFFF) { n +=  4; x <<=  4; }
      if (x <= 0x3FFFFFFF) { n +=  2; x <<=  2; }
      if (x <= 0x7FFFFFFF) { n +=  1; }
      return n;
    },
    get msb() { return this.val32 === 0 ? 'â€”' : 31 - this.nlz; }
  };
}

function ntzDemo() {
  return {
    hexIn: '0x00000100',
    val32: 0x00000100,
    parseH() {
      const v = parseInt(this.hexIn, 16);
      if (!isNaN(v)) this.val32 = v >>> 0;
    },
    setV(v) {
      this.val32 = v >>> 0;
      this.hexIn = '0x' + (v >>> 0).toString(16).toUpperCase().padStart(8,'0');
    },
    get bits() { return Array.from({length:32},(_,i)=>((this.val32>>>(31-i))&1)); },
    get ntz() {
      if (this.val32 === 0) return 32;
      // De Bruijn æ³•
      const table = [0,1,28,2,29,14,24,3,30,22,20,15,25,17,4,8,
                     31,27,13,23,21,19,16,7,26,12,18,6,11,5,10,9];
      const v = this.val32 >>> 0;
      return table[(((v & -v) >>> 0) * 0x077CB531 >>> 0) >>> 27];
    },
    rulerFn(k) {
      // ntz(k)
      if (k === 0) return 32;
      const table = [0,1,28,2,29,14,24,3,30,22,20,15,25,17,4,8,
                     31,27,13,23,21,19,16,7,26,12,18,6,11,5,10,9];
      return table[(((k & -k) >>> 0) * 0x077CB531 >>> 0) >>> 27];
    }
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ECharts å›¾è¡¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initChartPop() {
  const el = document.getElementById('chart-pop');
  if (!el || typeof echarts === 'undefined') return;
  const chart = echarts.init(el, null, {renderer:'canvas'});
  chart.setOption({
    backgroundColor: 'transparent',
    grid: {top:20,bottom:50,left:55,right:20},
    tooltip: {trigger:'axis', backgroundColor:'#0d1117', borderColor:'#1e293b',
               textStyle:{color:'#94a3b8',fontFamily:'JetBrains Mono',fontSize:11}},
    xAxis: {
      type: 'category',
      data: ['æœ´ç´ å¾ªç¯(å¹³å‡)','Kernighan','HAKMEM mod63','Warrenåˆ†æ²»','CSA-8å…ƒç´ ','ç¡¬ä»¶POPCNT'],
      axisLabel: {color:'#475569', fontFamily:'JetBrains Mono', fontSize:10, rotate:12},
      axisLine: {lineStyle:{color:'#1e293b'}},
      splitLine: {show:false}
    },
    yAxis: {
      type:'value', name:'æŒ‡ä»¤æ•°(ä¼°ç®—)',
      nameTextStyle:{color:'#334155',fontFamily:'JetBrains Mono',fontSize:10},
      axisLabel:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:10},
      axisLine:{lineStyle:{color:'#1e293b'}},
      splitLine:{lineStyle:{color:'#0f172a'}}
    },
    series: [{
      type:'bar', barWidth:'50%',
      data: [
        {value:50, itemStyle:{color:'#ff4466'}},
        {value:32, itemStyle:{color:'#ff8c00'}},
        {value:18, itemStyle:{color:'#b14fff'}},
        {value:21, itemStyle:{color:'#00d4ff'}},
        {value:13, itemStyle:{color:'#00ff88'}},
        {value:1,  itemStyle:{color:'#00ff88', opacity:.6}}
      ],
      label:{show:true, position:'top', color:'#94a3b8',
             fontFamily:'JetBrains Mono', fontSize:10,
             formatter:(p)=>p.value+'æ¡'}
    }]
  });
  window.addEventListener('resize', ()=>chart.resize());
}

function initChartNlz() {
  const el = document.getElementById('chart-nlz');
  if (!el || typeof echarts === 'undefined') return;
  const chart = echarts.init(el, null, {renderer:'canvas'});
  chart.setOption({
    backgroundColor:'transparent',
    grid:{top:20,bottom:45,left:55,right:20},
    tooltip:{trigger:'axis',backgroundColor:'#0d1117',borderColor:'#1e293b',
             textStyle:{color:'#94a3b8',fontFamily:'JetBrains Mono',fontSize:11}},
    xAxis:{
      type:'category',
      data:['æœ´ç´ å¾ªç¯','äºŒåˆ†æœç´¢(åˆ†æ”¯)','äºŒåˆ†æœç´¢(æ— åˆ†æ”¯)','De BruijnæŸ¥è¡¨','æµ®ç‚¹å€Ÿç”¨','ç¡¬ä»¶LZCNT'],
      axisLabel:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:9,rotate:14},
      axisLine:{lineStyle:{color:'#1e293b'}},
      splitLine:{show:false}
    },
    yAxis:{
      type:'value',name:'ç›¸å¯¹å‘¨æœŸæ•°',
      nameTextStyle:{color:'#334155',fontFamily:'JetBrains Mono',fontSize:10},
      axisLabel:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:10},
      axisLine:{lineStyle:{color:'#1e293b'}},
      splitLine:{lineStyle:{color:'#0f172a'}}
    },
    series:[{
      type:'bar', barWidth:'50%',
      data:[
        {value:30, itemStyle:{color:'#ff4466'}},
        {value:8,  itemStyle:{color:'#ff8c00'}},
        {value:10, itemStyle:{color:'#b14fff'}},
        {value:6,  itemStyle:{color:'#00d4ff'}},
        {value:12, itemStyle:{color:'#475569'}},
        {value:1,  itemStyle:{color:'#00ff88'}}
      ],
      label:{show:true,position:'top',color:'#94a3b8',
             fontFamily:'JetBrains Mono',fontSize:10,
             formatter:(p)=>p.value+'cy'}
    }]
  });
  window.addEventListener('resize',()=>chart.resize());
}

function initChartRadar() {
  const el = document.getElementById('chart-radar');
  if (!el || typeof echarts === 'undefined') return;
  const chart = echarts.init(el, null, {renderer:'canvas'});
  chart.setOption({
    backgroundColor:'transparent',
    legend:{
      data:['Â§5-1 popcount','Â§5-2 parity','Â§5-3 nlz','Â§5-4 ntz'],
      textStyle:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:9},
      bottom:0
    },
    radar:{
      indicator:[
        {name:'ç®—æ³•ç²¾å¦™åº¦', max:10},
        {name:'å·¥ç¨‹å®ç”¨æ€§', max:10},
        {name:'å†å²å½±å“åŠ›', max:10},
        {name:'è·¨å¹³å°æ€§',   max:10},
        {name:'æ•™å­¦ä»·å€¼',   max:10},
        {name:'æ•°å­¦æ·±åº¦',   max:10}
      ],
      nameGap: 6,
      name:{textStyle:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:9}},
      splitLine:{lineStyle:{color:'#1e293b'}},
      axisLine:{lineStyle:{color:'#1e293b'}},
      splitArea:{areaStyle:{color:['rgba(0,255,136,.02)','transparent']}}
    },
    series:[{
      type:'radar',
      data:[
        {value:[9,9,10,9,9,8], name:'Â§5-1 popcount',
         lineStyle:{color:'#00ff88'}, areaStyle:{color:'rgba(0,255,136,.08)'},
         itemStyle:{color:'#00ff88'}},
        {value:[7,8,7,9,8,7],  name:'Â§5-2 parity',
         lineStyle:{color:'#00d4ff'}, areaStyle:{color:'rgba(0,212,255,.06)'},
         itemStyle:{color:'#00d4ff'}},
        {value:[8,9,8,8,9,9],  name:'Â§5-3 nlz',
         lineStyle:{color:'#b14fff'}, areaStyle:{color:'rgba(177,79,255,.06)'},
         itemStyle:{color:'#b14fff'}},
        {value:[9,8,7,8,8,10], name:'Â§5-4 ntz',
         lineStyle:{color:'#ff8c00'}, areaStyle:{color:'rgba(255,140,0,.06)'},
         itemStyle:{color:'#ff8c00'}}
      ]
    }],
    tooltip:{trigger:'item',backgroundColor:'#0d1117',borderColor:'#1e293b',
             textStyle:{color:'#94a3b8',fontFamily:'JetBrains Mono',fontSize:10}}
  });
  window.addEventListener('resize',()=>chart.resize());
}

function initChartPerf() {
  const el = document.getElementById('chart-perf');
  if (!el || typeof echarts === 'undefined') return;
  const chart = echarts.init(el, null, {renderer:'canvas'});
  chart.setOption({
    backgroundColor:'transparent',
    tooltip:{trigger:'item',backgroundColor:'#0d1117',borderColor:'#1e293b',
             textStyle:{color:'#94a3b8',fontFamily:'JetBrains Mono',fontSize:10}},
    grid:{top:20,bottom:55,left:45,right:20},
    xAxis:{
      type:'category',
      data:['POPCNT\n(Skylake)','Warren\nåˆ†æ²»21æ¡','CSA-8\nå…ƒç´ /å­—','HAKMEM\nmod63','Kernighan\n(avg16)','æœ´ç´ \nå¾ªç¯32æ­¥'],
      axisLabel:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:9,
                 interval:0, lineHeight:14},
      axisLine:{lineStyle:{color:'#1e293b'}},
      splitLine:{show:false}
    },
    yAxis:{
      type:'value', name:'cycles/å­—(è¶Šä½è¶Šå¥½)',
      nameTextStyle:{color:'#334155',fontFamily:'JetBrains Mono',fontSize:9},
      axisLabel:{color:'#475569',fontFamily:'JetBrains Mono',fontSize:9},
      axisLine:{lineStyle:{color:'#1e293b'}},
      splitLine:{lineStyle:{color:'#0f172a'}}
    },
    series:[{
      type:'bar', barWidth:'45%',
      data:[
        {value:1,    itemStyle:{color:'#00ff88'}},
        {value:8,    itemStyle:{color:'#00d4ff'}},
        {value:5,    itemStyle:{color:'#00ff88', opacity:.7}},
        {value:14,   itemStyle:{color:'#b14fff'}},
        {value:20,   itemStyle:{color:'#ff8c00'}},
        {value:50,   itemStyle:{color:'#ff4466'}}
      ],
      label:{show:true,position:'top',color:'#94a3b8',
             fontFamily:'JetBrains Mono',fontSize:9,
             formatter:(p)=>p.value+'cy'}
    }]
  });
  window.addEventListener('resize',()=>chart.resize());
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   èƒŒæ™¯ç²’å­ Canvas
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initBg() {
  const canvas = document.getElementById('bg');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let W, H, particles = [];
  const COLORS = ['#00ff8844','#00d4ff33','#b14fff22'];
  const BITS = '01';

  function resize() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  for (let i = 0; i < 55; i++) {
    particles.push({
      x: Math.random() * 1200,
      y: Math.random() * 800,
      vx: (Math.random()-.5)*.22,
      vy: (Math.random()-.5)*.22,
      char: BITS[Math.floor(Math.random()*2)],
      color: COLORS[Math.floor(Math.random()*3)],
      size: 9 + Math.random()*9,
      alpha: .12 + Math.random()*.18,
      blink: Math.random() * Math.PI * 2,
      blinkSpeed: .008 + Math.random()*.012
    });
  }

  function frame() {
    ctx.clearRect(0, 0, W, H);
    const now = Date.now() * .001;
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy;
      p.blink += p.blinkSpeed;
      if (p.x < -20) p.x = W + 20;
      if (p.x > W+20) p.x = -20;
      if (p.y < -20) p.y = H + 20;
      if (p.y > H+20) p.y = -20;
      const alpha = p.alpha * (.6 + .4 * Math.sin(p.blink));
      ctx.globalAlpha = alpha;
      ctx.fillStyle = p.color.slice(0,7);
      ctx.font = `${p.size}px "JetBrains Mono", monospace`;
      ctx.fillText(p.char, p.x, p.y);
    });
    ctx.globalAlpha = 1;
    requestAnimationFrame(frame);
  }
  frame();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ»šåŠ¨è¿›åº¦æ¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initProgress() {
  const bar = document.getElementById('prog');
  if (!bar) return;
  function update() {
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    bar.style.width = (scrollTop / scrollHeight * 100).toFixed(1) + '%';
  }
  window.addEventListener('scroll', update, {passive:true});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ç‚¹å¯¼èˆªé«˜äº®
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initDotNav() {
  const dots = document.querySelectorAll('.dot');
  const sections = ['hero','pop','parity','nlz','ntz','history','critique'];
  function onScroll() {
    let current = 'hero';
    sections.forEach(id => {
      const el = document.getElementById(id);
      if (el && el.getBoundingClientRect().top <= window.innerHeight * .45) current = id;
    });
    dots.forEach(d => {
      d.classList.toggle('active', d.dataset.sec === current);
    });
  }
  window.addEventListener('scroll', onScroll, {passive:true});
  dots.forEach(d => {
    d.addEventListener('click', () => {
      const target = document.getElementById(d.dataset.sec);
      if (target) target.scrollIntoView({behavior:'smooth'});
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ»šåŠ¨æ·¡å…¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initScrollFade() {
  const els = document.querySelectorAll('.card, .insight, .warn-box, .critic-box');
  const obs = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        e.target.style.opacity = '1';
        e.target.style.transform = 'translateY(0)';
        obs.unobserve(e.target);
      }
    });
  }, {threshold: 0.08});
  els.forEach(el => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(16px)';
    el.style.transition = 'opacity .45s ease, transform .45s ease';
    obs.observe(el);
  });
}
</script>
</body>
</html>
